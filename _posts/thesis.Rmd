---
title: "THESIS"
subtitle: "Travel Disparity in the Bipartite Commute Network during the COVID19 Pandemic: A case of Seoul"
author: "Jaegeon Lee & Jungyul Sohn"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: haddock
    self_contained: yes
    gallery: yes
    number_sections: yes
    pandoc_args: --number-offset=0
    code_folding: show
    toc_depth: 4
    lightbox: yes
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
require(knitr); require(rmdformats); require("DT")

options(width="480"); options(max.print="75")
options(digits=3); options(scipen=1000)
options(DT.options = list(class="display compact nowrap hover",
                          rownames=FALSE));
options(encoding = 'UTF-8')
knitr::opts_chunk$set(
	echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE,
	comment = ":)  ", collapse = FALSE, prompt = FALSE, tidy = FALSE,
	fig.align="center", fig.retina=2.5,
 aliases=c(h = 'fig.height', w = 'fig.width')
)

knitr::opts_knit$set(width=75)
```

```{r include=FALSE}
# free memory & and garbage collection
rm(list = ls()); gc()
set.seed(1004)
```

> R Setup

```{r message = FALSE, warning = FALSE}
library(tidyverse)
library(DescTools)
library(kableExtra)
library(rgdal)
library(rgeos)
library(sf)
library(raster)
library(spdep)
library(tmap)
library(tmaptools)
library(cartogram)
library(viridisLite)
library(patchwork) 
library(xts)
library(data.table)
library(od)
library(viridisLite)
library(DT)
library(foreach)
library(doParallel)
library(igraph)
library(tidygraph)
library(ggraph)
library(furrr)
library(rlist)
library(ggrepel)
library(ggeffects)
#library(rgl)
library(ca)
library(factoextra)
library(FactoMineR)
library(lwgeom)
library(bipartite)
library(tsibble)
library(lubridate)
library(hrbrthemes)
library(sjPlot)
library(forcats)
```

```{r}
#options(scipen = 100)
```

\
\

# -------------------------------------------------------
# -------------------------------------------------------
# -------------------------------------------------------
# community detection
# ---------------------------
## binding
Refer to the `.csv` file below
binding/cumu_tibble_yesscaling_modularity_CLK_2020_2021_01_time_111213_0720_1100_SemiModifiedExpectation.csv
2020년과 2021년 각각의 1월 평일 11:00 ~ 13:00 동안의 모든 통행 유형을 포함하는 통행 네트워크를 구축함.
위 네트워크를 바탕으로 합역적 바인딩을 수행함.

# ---------------------------
## import membership information 
```{r}
# membership_name_by_members_2020_2021_01_time_111213_0720_0121_OriginialExpectation.csv
# membership_name_by_members_2020_2021_01_time_111213_0720_0133_ModifiedExpectation.csv
membership_info_eng <- read_csv('data_membership/membership_info_eng_2020_2021_01_time_111213_0725_1313_SemiModifiedExpectation.csv', show_col_types = FALSE) %>%
    mutate(ADM_CD = as.character(ADM_CD))
membership_info_eng
```

# ---------------------------
## mapping
```{r}
dong.sf <- sf::st_read("data_shp/seoul_dong_EPSG_5179/seoul_dong_EPSG_5179.shp", options = "ENCODING=euc-kr")

dong.sf <- dong.sf %>%  
    mutate(ADM_NM = replace(ADM_NM, ADM_CD == "1121068", "관악신사동"))
```

```{r}
dong.sf_commune <- dong.sf %>%
    st_snap_to_grid(size = 0.02) %>%
    st_make_valid() %>%
    left_join(membership_info_eng,
              by = "ADM_CD") %>%
    group_by(member, member_eng) %>%
    summarise(geometry = st_union(geometry)) %>%                            
    mutate(member = factor(member)) %>%
    mutate(area = sf::st_area(geometry)) %>%
    mutate(member = as.character(member)) 
dong.sf_commune
```

```{r fig.align="center", echo = FALSE, fig.width = 20, fig.height = 20}
tmap_mode('plot')
tm_shape(dong.sf) +
    tm_borders(col = "grey", lwd = 1) +
    tm_text("ADM_NM", size = 0.7) +
tm_shape(dong.sf_commune) +
    tm_polygons(col = "MAP_COLORS", palette = "Pastel2", stretch.palette = TRUE, alpha = 0.2, lwd = 3) +
    tm_text("member_eng", size = 1.5) +
    tmap_options(max.categories = 50, check.and.fix = TRUE)
```


\
\

# -------------------------------------------------------
# -------------------------------------------------------
# -------------------------------------------------------
# representation of two modes
# ---------------------------
# residential mode 
# -----------
## import
```{r}
resid_mode <- read_csv('data_residential/demo_data.csv') %>%
    rename(resid_size = total) %>%
    mutate(one_person_household = one_person_household * 100,
           college = college * 100)
resid_mode
```

# -----------
## resid_mode
# -----------
## mapping 
```{r fig.align="center", echo = FALSE, fig.width = 20, fig.height = 20}
dong.sf_commune_resid <- dong.sf_commune %>%
    left_join(resid_mode, by = "member_eng") %>%
    ungroup()

tm_shape(dong.sf_commune_resid) +
        tm_polygons(col = "college",
                    border.col = "grey",
                border.lwd = 0.3,
                #legend.hist = TRUE,
                style = "jenks",
                palette = magma(n=50, direction = -1),
                textNA = "누락값") +
        tm_layout(
                  #legend.outside.position = "left",
                  legend.outside = FALSE,
                  legend.width = 2,
                  legend.title.size = 2,
                  legend.title.color = "white",
                  legend.text.size = 1,
                  main.title = "residential mode : college", main.title.position = "left") 
```

# ---------------------------
# employment mode
# -----------
## import
```{r}
jongsaja <- readxl::read_xls("data_industrial/economic_activity_survey_by_industry.xls")

colnames(jongsaja) <- c("sgg_nm", "emd_nm", "total_employ", 
                        "Agri", "Mine", 
                        "Manu", "ElecGas", "WaterSweage", "Const","WholeRetail", 
                        "Logis", "HotelRestaurant","InfoCommunic", "FinanInsu", "Estate",
                        "ProfScieTech", "BusiFacil", 
                        "PubServ", "Edu", "HealthWelf", "Leisure", "AssocPersonalServ") 

jongsaja <- jongsaja %>%
    slice(-1) %>%
    filter(emd_nm != "소계") %>%
    mutate_at(4:22, as.numeric) %>%
    mutate_at(4:22, replace_na, 0) %>%
    mutate(emd_nm = replace(emd_nm, emd_nm=="종로1.2.3.4가동", "종로1·2·3·4가동"),
           emd_nm = replace(emd_nm, emd_nm=="금호2.3가동", "금호2·3가동"),
           emd_nm = replace(emd_nm, emd_nm=="면목3.8동", "면목3·8동"),
           emd_nm = replace(emd_nm, emd_nm=="상계3.4동", "상계3·4동"),
           emd_nm = replace(emd_nm, emd_nm=="상계6.7동", "상계6·7동"),
           emd_nm = replace(emd_nm, emd_nm=="중계2.3동", "중계2·3동"),
           emd_nm = replace(emd_nm, sgg_nm=="관악구" & emd_nm=="신사동", "관악신사동"),
           emd_nm = replace(emd_nm, emd_nm=="여의도동", "여의동")) %>%
    dplyr::select(-c(sgg_nm, total_employ)) %>%
    as.data.frame()
jongsaja %>% 
    DT::datatable()
```

## employment density by adm_dong
```{r}
dong_area <- dong.sf %>%
    mutate(area = st_area(geometry)) %>%
    st_drop_geometry() %>%
    select(ADM_CD, ADM_NM, area) 

jongsaja_rowsums <- jongsaja %>%
    column_to_rownames("emd_nm") %>%
    rowSums() 

jongsaja_rowsums <- cbind(jongsaja_rowsums, jongsaja$emd_nm)

jongsaja_rowsums<- jongsaja_rowsums %>%
    as_tibble() 

colnames(jongsaja_rowsums) <- c("total_employment", "ADM_NM")

jongsaja_rowsums <- jongsaja_rowsums %>%
    left_join(dong_area, by = "ADM_NM")

jongsaja_rowsums <- jongsaja_rowsums %>%
    mutate(area = as.numeric(area),
           total_employment = as.numeric(total_employment)) %>%
    mutate(density = total_employment / area)
jongsaja_rowsums
rm(dong_area)
```

```{r fig.align="center", echo = FALSE, fig.width = 15, fig.height = 7}
tmap_mode("plot")
dong.sf_density <- dong.sf %>%
    left_join(jongsaja_rowsums, by = "ADM_NM") %>%
    mutate(log_total_employment = log(total_employment),
           log_density = log(density * 10000))

m1 <- tm_shape(dong.sf_density) +
    tm_polygons("log_total_employment")
m2 <- tm_shape(dong.sf_density) +
    tm_polygons("log_density")

tmap_arrange(m1, m2)
rm(m1, m2)
rm(dong.sf_density)
```

## aggregate by community
```{r}
b <- dong.sf %>%
    st_drop_geometry() %>%
    select(ADM_CD, ADM_NM) 

jongsaja_comm <- jongsaja %>%
    left_join(b, by = c("emd_nm" = "ADM_NM")) %>%
    relocate(ADM_CD, emd_nm) %>%
    left_join(membership_info_eng, by = "ADM_CD") %>%
    relocate(ADM_CD, ADM_NM, member, member_eng) %>%
    select(-emd_nm) %>%
    group_by(member_eng) %>%
    summarise(across(is.numeric, ~ sum(.x, na.rm = TRUE))) 

jongsaja_comm <- jongsaja_comm %>%
    select(-c(Agri, Mine, ElecGas, WaterSweage))
jongsaja_comm
```

```{r}
jongsaja_comm %>%
    write_csv("data_industrial/jongsaja_comm.csv")
```

## spatial distribution by industry
### set up
```{r}
dong.sf_commune_byindustry <- dong.sf_commune %>%
    left_join(jongsaja_comm, by = "member_eng") %>%
    mutate(
            Manu_dens = Manu/ as.numeric(area),
            Const_dens = Const/ as.numeric(area),
            WholeRetail_dens = WholeRetail/ as.numeric(area),
            Logis_dens = Logis/ as.numeric(area),
            HotelRestaurant_dens = HotelRestaurant/ as.numeric(area),
            InfoCommunic_dens = InfoCommunic/ as.numeric(area),
            FinanInsu_dens = FinanInsu/ as.numeric(area),
            Estate_dens = Estate/ as.numeric(area),
            ProfScieTech_dens = ProfScieTech/ as.numeric(area),
            BusiFacil_dens = BusiFacil/ as.numeric(area),
            PubServ_dens = PubServ/ as.numeric(area),
            Edu_dens = Edu/ as.numeric(area),
            HealthWelf_dens = HealthWelf/ as.numeric(area),
            Leisure_dens = Leisure/ as.numeric(area),
            AssocPersonalServ_dens = AssocPersonalServ/ as.numeric(area))  %>%
    mutate(total = Manu + Const + WholeRetail + Logis + HotelRestaurant + InfoCommunic + FinanInsu + Estate + 
                   ProfScieTech + BusiFacil + PubServ + Edu + HealthWelf + Leisure + AssocPersonalServ) %>%
    mutate(
            Manu_share = Manu/ total * 100,
            Const_share = Const/ total * 100,
            WholeRetail_share = WholeRetail/ total * 100,
            Logis_share = Logis/ total * 100,
            HotelRestaurant_share = HotelRestaurant/ total * 100,
            InfoCommunic_share = InfoCommunic/ total * 100,
            FinanInsu_share = FinanInsu/ total * 100,
            Estate_share = Estate/ total * 100,
            ProfScieTech_share = ProfScieTech/ total * 100,
            BusiFacil_share = BusiFacil/ total * 100,
            PubServ_share = PubServ/ total * 100,
            Edu_share = Edu/ total * 100,
            HealthWelf_share = HealthWelf/ total * 100,
            Leisure_share = Leisure/ total * 100,
            AssocPersonalServ_share = AssocPersonalServ/ total * 100) 
dong.sf_commune_byindustry
```

### counts
```{r}
# 15개
#list_of_industries <- c("Manu", "Const","WholeRetail", 
#                     "Logis", "HotelRestaurant","InfoCommunic", "FinanInsu", "Estate",
#                     "ProfScieTech", "BusiFacil", 
#                     "PubServ", "Edu", "HealthWelf", "Leisure", "AssocPersonalServ")
```

```{r fig.align="center", echo = FALSE, fig.width = 15, fig.height = 7}
#list_of_maps <- list()
#list_of_maps <- purrr::map(list_of_industries, mapping_function)
```

```{r fig.align="center", echo = FALSE, fig.width = 30, fig.height = 20}
#tmap_arrange(list_of_maps %>% pluck(1), list_of_maps %>% pluck(2), list_of_maps %>% pluck(3), list_of_maps %>% pluck(4),
#             list_of_maps %>% pluck(5), list_of_maps %>% pluck(6), list_of_maps %>% pluck(7), list_of_maps %>% pluck(8),
#             list_of_maps %>% pluck(9), list_of_maps %>% pluck(10), list_of_maps %>% pluck(11), list_of_maps %>% pluck(12),
#             list_of_maps %>% pluck(13), list_of_maps %>% pluck(14), list_of_maps %>% pluck(15))
```

### density
```{r}
#list_of_industries_dens <- c("Manu_dens", "Const_dens","WholeRetail_dens", 
#                          "Logis_dens", "HotelRestaurant_dens","InfoCommunic_dens", "FinanInsu_dens", "Estate_dens",
#                          "ProfScieTech_dens", "BusiFacil_dens", 
#                          "PubServ_dens", "Edu_dens", "HealthWelf_dens", "Leisure_dens", "AssocPersonalServ_dens")
```

```{r}
#mapping_function <- function(specific_sector) {
#    
#    map <- tm_shape(dong.sf_commune_byindustry) +
#             tm_polygons(as.character(specific_sector))
#    
#    return(map)
#}
```

```{r fig.align="center", echo = FALSE, fig.width = 15, fig.height = 7}
#list_of_maps_dens <- list()
#list_of_maps_dens <- purrr::map(list_of_industries_dens, mapping_function)
```

```{r fig.align="center", echo = FALSE, fig.width = 30, fig.height = 20}
#tmap_arrange(list_of_maps_dens %>% pluck(1), list_of_maps_dens %>% pluck(2), list_of_maps_dens %>% pluck(3), list_of_maps_dens %>% pluck(4),
#             list_of_maps_dens %>% pluck(5), list_of_maps_dens %>% pluck(6), list_of_maps_dens %>% pluck(7), list_of_maps_dens %>% pluck(8),
#             list_of_maps_dens %>% pluck(9), list_of_maps_dens %>% pluck(10), list_of_maps_dens %>% pluck(11), list_of_maps_dens %>% pluck(12),
#             list_of_maps_dens %>% pluck(13), list_of_maps_dens %>% pluck(14), list_of_maps_dens %>% pluck(15))
```

### share
```{r}
list_of_industries_share <- c("Manu_share", "Const_share","WholeRetail_share", 
                          "Logis_share", "HotelRestaurant_share","InfoCommunic_share", "FinanInsu_share", "Estate_share",
                          "ProfScieTech_share", "BusiFacil_share", 
                          "PubServ_share", "Edu_share", "HealthWelf_share", "Leisure_share", "AssocPersonalServ_share")
```

```{r}
mapping_function <- function(specific_sector) {
    
    map <- tm_shape(dong.sf_commune_byindustry) +
             tm_polygons(col = as.character(specific_sector))
    
    return(map)
}
```

```{r fig.align="center", echo = FALSE, fig.width = 15, fig.height = 7}
list_of_maps_share <- list()
list_of_maps_share <- purrr::map(list_of_industries_share, mapping_function)
```


```{r fig.align="center", echo = FALSE, fig.width = 30, fig.height = 20}
tmap_arrange(list_of_maps_share %>% pluck(1), list_of_maps_share %>% pluck(2), list_of_maps_share %>% pluck(3), list_of_maps_share %>% pluck(4),
             list_of_maps_share %>% pluck(5), list_of_maps_share %>% pluck(6), list_of_maps_share %>% pluck(7), list_of_maps_share %>% pluck(8),
             list_of_maps_share %>% pluck(9), list_of_maps_share %>% pluck(10), list_of_maps_share %>% pluck(11), list_of_maps_share %>% pluck(12),
             list_of_maps_share %>% pluck(13), list_of_maps_share %>% pluck(14), list_of_maps_share %>% pluck(15))
```

# -----------
## PCA 
### set up for compositional data
```{r}
jongsaja_comm <- as.table(as.matrix(jongsaja_comm %>% column_to_rownames('member_eng'))) 

jongsaja_comm_acomp <- compositions::acomp(jongsaja_comm)
jongsaja_comm_acomp <- jongsaja_comm_acomp %>%
    as.matrix() %>%
    as.data.frame()
jongsaja_comm_acomp
```

### CLR
```{r}
jongsaja_comm_acomp_clr <- easyCODA::CLR(jongsaja_comm_acomp)$LR
LR_wt <- easyCODA::CLR(jongsaja_comm_acomp)$LR.wt
```

### row weight 
total employment and emp density
```{r}
commune_emp_total_dens <- dong.sf_commune_byindustry %>%
    st_drop_geometry() %>%
    mutate(area = as.numeric(area)) %>%
    mutate(emp_density = total / area * 100) %>%    # 100제곱미터당 종사자수
    select(member, member_eng, total, emp_density) 

commune_emp_total_dens <- commune_emp_total_dens %>%
    ungroup() %>%
    mutate(total = total / sum(total)) %>%
    arrange(member_eng) %>%                                     # member_eng의 알파벳 순으로
    pull(total) 
commune_emp_total_dens
```

### conduct
```{r}
jongsaja_comm_acomp_clr_pca <- easyCODA::PCA(jongsaja_comm_acomp_clr,
                                             nd = 2,
                                             weight = LR_wt,
                                             row.wt = commune_emp_total_dens 
                                             )
jongsaja_comm_acomp_clr_pca
```

### biplot 
```{r fig.align="center", echo = FALSE, fig.width = 25, fig.height = 18}
easyCODA::PLOT.PCA(jongsaja_comm_acomp_clr_pca,
                   map = "contribution",
                   dim = c(1,2),
                   colarrows = "pink",
                   cex = c(1, 1.3),
                   main = "contribution PCA plot",
                   rescale = 1)                   # the default 가로 세로 비율
```

# -----------
## WARD clustering 
### set up for compositional data
```{r}
jongsaja_comm_acomp
```

### CLR
```{r}
jongsaja_comm_acomp_clr <- easyCODA::CLR(jongsaja_comm_acomp)$LR
jongsaja_comm_acomp_clr
```

```{r}
LR_wt <- easyCODA::CLR(jongsaja_comm_acomp)$LR.wt
LR_wt
```

### conduct
```{r}
jongsaja_comm_acomp_clr_ward <- easyCODA::WARD(jongsaja_comm_acomp_clr,
                                               weight = LR_wt,
                                               row.wt = commune_emp_total_dens
                                               )
jongsaja_comm_acomp_clr_ward
```

```{r fig.align="center", echo = FALSE, fig.width = 15, fig.height = 15}
plot(jongsaja_comm_acomp_clr_ward, labels = rownames(jongsaja_comm_acomp_clr))
rect.hclust(jongsaja_comm_acomp_clr_ward, k = 6, border = "red")
```

### number of clusters
```{r}
jongsaja_comm_acomp_mat <- jongsaja_comm_acomp %>% 
    as.matrix() %>%
    as.data.frame()
jongsaja_comm_acomp_mat
```

```{r}
fviz_nbclust(jongsaja_comm_acomp_mat, FUN = hcut, method = "wss", title = "")
fviz_nbclust(jongsaja_comm_acomp_mat, FUN = hcut, method = "silhouette")
```

### employment_mode_cluster
```{r}
rownames(jongsaja_comm_acomp_clr)
```

```{r}
emp_mode <- as.data.frame(as.matrix(cutree(jongsaja_comm_acomp_clr_ward, k = 6))) %>%
    rownames_to_column() %>%
    as_tibble() %>%
    bind_cols(rownames(jongsaja_comm_acomp_clr)) %>%
    select(-rowname)
colnames(emp_mode) <- c("cluster", "member_eng") 
emp_mode
```

#### reorder
고밀도 순으로 높은 nominal label을 가지도록록
안 해도 됨

# -----------
## emp_mode
### emp_size
```{r}
jongsaja_comm <- read_csv("data_industrial/jongsaja_comm.csv")

emp_size <- jongsaja_comm %>%
    as.data.frame() %>%
    column_to_rownames("member_eng") %>%
    rowSums() %>%
    as.data.frame() %>%
    rownames_to_column() %>%
    as_tibble()
colnames(emp_size) <- c("member_eng", "emp_size")
emp_size
```

### share_of_KIBS
```{r}
KIBS <- jongsaja_comm_acomp %>%
    rownames_to_column("member_eng") %>%
    as_tibble() %>%
    select(member_eng, InfoCommunic, FinanInsu, ProfScieTech, Edu) %>%
    mutate(share_of_KIBS = (InfoCommunic + FinanInsu + ProfScieTech + Edu) * 100) %>%
    select(member_eng, share_of_KIBS) %>%
    arrange(desc(share_of_KIBS))
KIBS
```

### integrate
```{r}
emp_mode <- emp_mode %>%
    left_join(emp_size, by = "member_eng") %>%
    left_join(KIBS, by = "member_eng") %>%
    relocate(member_eng, emp_size, cluster, share_of_KIBS)
emp_mode
rm(emp_size)
```

# -----------
## mapping
```{r}
dong.sf_commune_resid_emp <- dong.sf_commune_resid %>%
    left_join(emp_mode, by = "member_eng")%>%
    mutate(cluster = factor(cluster)) %>% 
    ungroup() 
dong.sf_commune_resid_emp
```

```{r fig.align="center", echo = FALSE, fig.width = 30, fig.height = 25}
tmap_mode("plot")
tm_shape(dong.sf_commune_resid_emp) +
    tm_polygons(col = "cluster", alpha = 0.3,
                popup.vars = c("member_eng"),
                title = "클러스터") +
    tm_text("member_eng", size = 2) +
    tmap_options(max.categories = 31, check.and.fix = TRUE) +
tm_layout(
  legend.title.size = 4,
  legend.text.size = 2,
  legend.position = c("left","bottom"),
  legend.bg.color = "white",
  legend.bg.alpha = 1) +
    tm_compass(type = "4star", size = 8, position = c("left", "top")) +
    tm_scale_bar(size = 4, position = c("left", "top"))
```

# -----------
## parallel coordinate plot
### industry_order_by_edu
```{r}
edu_industry_occupation <- readxl::read_xlsx("data_industrial/mdis_census_analysis/economic_active_pop_edu_industry_occpuation.xlsx",
                                             col_types = c("text"))

colnames(edu_industry_occupation) <- c("dem", "nu1", "nu2", "industry", "occupation", "edu_level", "age")

edu_industry_occupation <- edu_industry_occupation %>%
    select(dem, industry, occupation, edu_level, age) %>%
    filter(dem == "1") %>%                      # 동부 도시지역만 
    filter(industry != "0") %>%                 
    filter(occupation != "0") %>%
    select(-dem) %>%
    group_by(industry, occupation, edu_level) %>%
    summarise(count = n())

edu_by_industry <- edu_industry_occupation %>%
    ungroup() %>%
    group_by(industry, edu_level) %>%
    summarise(count = sum(count))
rm(edu_industry_occupation)

edu_by_industry <- edu_by_industry %>%
    pivot_wider(names_from = edu_level, values_from = count)
colnames(edu_by_industry) <- c("industry" , "below_elementary", "middle", "high", "semi_college", "college", "college_graduate")

edu_by_industry <- edu_by_industry %>%
    mutate(college_and_above = sum(college + college_graduate) / sum(below_elementary + middle + high + semi_college + college + college_graduate) * 100) %>%
    select(industry, college_and_above) %>%
    mutate(industry = recode(industry,
           'A' = 'Agri',
           'B' = 'Mine',
           'C' = 'Manu',
           'D' = 'ElecGas',
           'E' = 'WaterSweage',
           'F' = 'Const',
           'G' = 'WholeRetail',
           'H' = 'Logis',
           'I' = 'HotelRestaurant',
           'J' = 'InfoCommunic',
           'K' = 'FinanInsu',
           'L' = 'Estate',
           'M' = 'ProfScieTech',
           'N' = 'BusiFacil',
           'O' = 'PubServ',
           'P' = 'Edu',
           'Q' = 'HealthWelf',
           'R' = 'Leisure',
           'S' = 'AssocPersonalServ',
           'T' = 'nu1',
           'U' = 'nu2'))
```

```{r fig.align="center", echo = FALSE, fig.width = 20, fig.height = 13}
edu_by_industry %>%
    arrange(college_and_above) %>%
    filter(!industry %in% c("nu1", "nu2")) %>%
    ggplot(aes(x = reorder(industry, college_and_above), y = college_and_above)) +    # aes mapping에서 reorder 할 것
    geom_col() +
  theme(
    #plot.title = element_text(size = 50),0
    axis.text.x = element_text(angle = 45, size = 20))
```

```{r}
industry_order_by_edu <- edu_by_industry %>%
    filter(!industry %in% c("nu1", "nu2")) %>%
    arrange(college_and_above) %>%
    filter(!industry %in% c("Agri", "Mine", "WaterSweage", "ElecGas"))
industry_order_by_edu
#rm(edu_by_industry)
```

```{r}
industry_order_by_edu <- industry_order_by_edu %>%
    ungroup() %>%
    pull(industry)
industry_order_by_edu
```

### composition data
```{r}
jongsaja_comm_acomp_mat %>%
    rowSums()
```

```{r}
jongsaja_comm_acomp_mat_cluster <- jongsaja_comm_acomp_mat %>%
    bind_cols(emp_mode) %>%
    mutate(cluster = factor(cluster)) %>%
    select(-member_eng) %>%
    select(-share_of_KIBS) %>%
    select(-emp_size) %>%
    mutate(across(where(is.numeric), ~ .x * 100))
jongsaja_comm_acomp_mat_cluster
```

```{r fig.align="center", echo = FALSE, fig.width = 30, fig.height = 20}
#p1 <- GGally::ggparcoord(jongsaja_comm_acomp_mat_cluster %>%
#                             filter(Logis < 50),
#                   scale = "globalminmax",
#    columns = 1:15, groupColumn = 16, order = "anyClass", 
#    showPoints = TRUE, 
#    title = "",
#    alphaLines = 0.8,
#    boxplot = TRUE
#    #shadeBox = "white"
#    ) + 
#  #scale_color_viridis(discrete=TRUE) +
#    labs(x = "sector",
#         y = "share (%)",
#         colour = "cluster") +
#  hrbrthemes::theme_ipsum() +
#  theme(
#    #plot.title = element_text(size = 50),0
#    axis.text.x = element_text(angle = 45, size = 20),
#    axis.text.y = element_text(size = 20),
#    axis.title.x = element_text(size = 30, hjust = 0.5),
#    axis.title.y = element_text(size = 30, hjust = 0.5),
#    legend.position = c(0.5, 0.9),
#    legend.direction = "horizontal",
#    legend.title = element_text("cluster", size = 20),
#    legend.key.size = unit(3, 'cm'),
#    legend.text = element_text(size = 20),
#    legend.background = element_rect(color = "white"))
#plotly::ggplotly(p1)
```

```{r fig.align="center", echo = FALSE, fig.width = 30, fig.height = 20}
p <- GGally::ggparcoord(jongsaja_comm_acomp_mat_cluster %>%
                             filter(Logis < 50),
                   scale = "std",
    columns = 1:15, groupColumn = 16, order = "anyClass", 
    showPoints = TRUE, 
    title = "",
    alphaLines = 0.8,
    boxplot = TRUE
    #shadeBox = "white"
    ) + 
  #scale_color_viridis(discrete=TRUE) +
    labs(x = "sector",
         y = "standardized share",
         colour = "cluster") +
  hrbrthemes::theme_ipsum() +
  theme(
    #plot.title = element_text(size = 50),0
    axis.text.x = element_text(angle = 45, size = 20),
    axis.text.y = element_text(size = 20),
    axis.title.x = element_text(size = 30, hjust = 0.5),
    axis.title.y = element_text(size = 30, hjust = 0.5),
    legend.position = c(0.5, 0.9),
    legend.direction = "horizontal",
    legend.title = element_text("cluster", size = 20),
    legend.key.size = unit(3, 'cm'),
    legend.text = element_text(size = 20),
    legend.background = element_rect(color = "white"))
plotly::ggplotly(p)
```

# ---------------------------
# visualization of BCN
```{r message = FALSE, warning = FALSE}
#library(sf)
#library(raster)
#library(stars)
#library(r5r)
##library(geobr)
##library(aopdata)
#library(gtfs2gps)
#library(ggplot2)
#library(osmdata)
#library(h3jsr)
#library(viridisLite)
#library(ggnewscale)
#library(dplyr)
#library(magrittr)
#library(viridis)
```

# -----------
## layer of mode
```{r}
#dong.sf_commune_resid_emp_forggplot <- dong.sf_commune_resid_emp %>%
#    st_transform(4326)
#dong.sf_commune_resid_emp_forggplot
```

```{r}
## thanks to Stefan Jünger.
#rotate_data <- function(data, x_add = 0, y_add = 0) {
#  
#  shear_matrix <- function(){ matrix(c(2, 1.2, 0, 1), 2, 2) }
# 
#  rotate_matrix <- function(x){ 
#    matrix(c(cos(x), sin(x), -sin(x), cos(x)), 2, 2) 
#  }
#  data %>% 
#    dplyr::mutate(
#      geometry = .$geometry * shear_matrix() * rotate_matrix(pi/60) + c(x_add, y_add)
#    )
#}
```

```{r}
#ggplot() +
#    geom_sf(data = dong.sf_commune_resid_emp_forggplot %>%
#                  rotate_data())
```

# -----------
## linestrings
### import 
```{r}
#flow_2020 <- read_csv("data_flow/flow_data_2020_01_789.csv")
#flow_2020 <- flow_2020 %>%
#    mutate(DEPRTP = as.character(DEPRTP),
#           DESTNTN = as.character(DESTNTN))
#
#flow_2020 <- flow_2020 %>%
#    left_join(membership_info_eng, by = c("DEPRTP" = "ADM_CD")) %>%
#    left_join(membership_info_eng, by = c("DESTNTN" = "ADM_CD")) %>%
#    group_by(member_eng.x, member_eng.y) %>%
#    summarise(LIFE_FLPOP = sum(LIFE_FLPOP)) %>%
#    relocate(member_eng.x, member_eng.y, LIFE_FLPOP)      # 커뮤니티 단위로 합역한 이후 링크수는 112,540개에서 #3599개로 
#
#flow_2020
#
#flow_2020_mat <- flow_2020 %>%
#    od_to_odmatrix() 
#
#flow_2020_mat[is.na(flow_2020_mat)] <- 0
#
#flow_2020_mat %>% 
#    as.data.frame()
```

```{r}
#flow_2021 <- read_csv("data_flow/flow_data_2021_01_789.csv")
#flow_2021 <- flow_2021 %>%
#    mutate(DEPRTP = as.character(DEPRTP),
#           DESTNTN = as.character(DESTNTN))
#
#flow_2021 <- flow_2021 %>%
#    left_join(membership_info_eng, by = c("DEPRTP" = "ADM_CD")) %>%
#    left_join(membership_info_eng, by = c("DESTNTN" = "ADM_CD")) %>%
#    group_by(member_eng.x, member_eng.y) %>%
#    summarise(LIFE_FLPOP = sum(LIFE_FLPOP)) %>%
#    relocate(member_eng.x, member_eng.y, LIFE_FLPOP)      # 커뮤니티 단위로 합역한 이후 링크수는 112,540개에서 #3599개로 
#
#flow_2021
#
#flow_2021_mat <- flow_2021 %>%
#    od_to_odmatrix() 
#
#flow_2021_mat[is.na(flow_2021_mat)] <- 0
#
#flow_2021_mat %>% 
#    as.data.frame()
```

### edit
```{r}
#flow_2020_2021 <- flow_2020 %>%
#    left_join(flow_2021, by = c("member_eng.x", "member_eng.y"), suffix = c("_2020", "_2021")) %>%
#    mutate(reducing_rate = LIFE_FLPOP_2021 / LIFE_FLPOP_2020)
#flow_2020_2021
```

```{r}
#emp_mode_membership <- dong.sf_commune_resid_emp %>%
#    st_drop_geometry() %>%
#    select(member_eng, cluster) 
```

```{r}
#dong.sf_commune_centroid <- dong.sf_commune %>%
#    st_centroid() %>%
#    st_transform(5179) %>%
#    select(member_eng) 
```

```{r}
#a <- flow_2020_2021
#
#a_od <- a %>%
#    relocate(member_eng.x, member_eng.y, reducing_rate) %>%              # 바꿔줘야 함
#    od::od_to_sf(dong.sf_commune_centroid,
#                 zd = NULL, odc = NULL, filter = TRUE, crs = 5179)
#
#a_od_forggplot <- a_od %>%
#    st_transform(4326)
#
#### 중요
#a_od_forggplot <- a_od_forggplot %>%
#    rotate_data()
####
#
#a_od_forggplot <- as.character(a_od_forggplot$geometry)
#
#a_od_forggplot <- a_od_forggplot %>%
#    as.data.frame() %>%
#    as_tibble() 
#colnames(a_od_forggplot) <- "coord"
#
#a_od_forggplot <- a_od_forggplot %>%
#    mutate(coord = str_sub(coord, start = 3L),
#           coord = str_sub(coord, end = -2L)) %>%
#    tidyr::separate(coord, sep = ", ", into = c("from_x", "to_x", "from_y", "to_y")) %>%
#    mutate_all(as.numeric)
#
#a_od_forggplot <- a_od_forggplot %>%
#    bind_cols(a_od) %>%
#    relocate(from_x, to_x, from_y, to_y, reducing_rate) %>%
#    left_join(emp_mode_membership, by = c("member_eng.y" = "member_eng"))
#
#flow_2020_2021_od_forggplot <- a_od_forggplot
#flow_2020_2021_od_forggplot
#rm(a, a_od, a_od_forggplot)
```

# -----------
## summary statistics
```{r}
#flow_2020_2021_od_forggplot %>%
#    pivot_longer(c("LIFE_FLPOP_2020", "LIFE_FLPOP_2021"), names_to = "year", values_to = "LIFE_FLPOP")
```

```{r}
#flow_2020_2021_od_forggplot %>%
#    pivot_longer(c("LIFE_FLPOP_2020", "LIFE_FLPOP_2021"), names_to = "year", values_to = "LIFE_FLPOP") %>%
#    ggpubr::gghistogram(x = "LIFE_FLPOP",
#                      fill = "year",
#                      add = "median", palette = c("#00AFBB", "#E7B800")) 
```

```{r fig.align="center", echo = FALSE, fig.width = 10, fig.height = 20}
#flow_2020_2021_od_forggplot %>%
#    mutate(rowname = as.character(row_number())) %>%
#    pivot_longer(c("LIFE_FLPOP_2020", "LIFE_FLPOP_2021"), names_to = "year", values_to = "LIFE_FLPOP") %>%
#    ggpubr::ggpaired(x = "year",
#                     color = "year",
#                     y = "LIFE_FLPOP",
#                     line.color = "gray", line.size = 0.4,
#                     id = "rowname") +    # defining id is very important to draw all paired lines
#    ggpubr::stat_compare_means(method = "wilcox.test", 
#                               paired = TRUE,
#                               label.y = 0.3,
#                               label = "p.format",
#                               na.rm = TRUE) +
#    theme(axis.text.x = element_text(size = 10, angle = 0, vjust = 0.0))
```

```{r fig.align="center", echo = FALSE, fig.width = 10, fig.height = 20}
#flow_2020_2021_od_forggplot %>%
#    mutate(rowname = as.character(row_number())) %>%
#    pivot_longer(c("LIFE_FLPOP_2020", "LIFE_FLPOP_2021"), names_to = "year", values_to = "LIFE_FLPOP") %>%
#    mutate(log_LIFE_FLPOP = log(LIFE_FLPOP)) %>%
#    ggpubr::ggpaired(x = "year",
#                     color = "year",
#                     y = "log_LIFE_FLPOP",
#                     line.color = "gray", line.size = 0.4,
#                     id = "rowname") +    # defining id is very important to draw all paired lines
#    ggpubr::stat_compare_means(method = "wilcox.test", 
#                               paired = TRUE,
#                               label.y = 0.3,
#                               label = "p.format",
#                               na.rm = TRUE) +
#    theme(axis.text.x = element_text(size = 10, angle = 0, vjust = 0.0))
```

```{r}
#flow_2020_2021_od_forggplot %>%
#    ggplot() +
#    geom_histogram(aes(x = reducing_rate))
```

# -----------
## visualize (reducing rate)
### functionalize
```{r}
#visualize_two_layers <- function(a) {
#    ggplot() +
#    geom_sf(data = dong.sf_commune_resid_emp_forggplot %>%
#                  rotate_data(),
#              aes(fill = cluster),
#              size = 1, alpha = 0.3) +
#      #ggtitle("Destination") +
#        scale_fill_viridis(discrete = TRUE, option = "viridis", direction = -1) +
#        annotate("text", label = "destination", 
#                 #x = 4400000, y = 1730000, hjust = 0, 
#                 color="black") +
#        theme(legend.position = "none") + # Clean Everything 
#        
#        ggnewscale::new_scale_fill() + 
#        ggnewscale::new_scale_color() +
#                
#    geom_segment(data = a,    # 여기서 rotate_data() 적용하지 말것!!
#                     aes(x = from_x, xend = to_x, y = from_y + 0.4, yend = to_y,   # 여기서 높이를 줄 것!!
#                       #size = net_weight_contracted.2020_absolute, 
#                       col = reducing_rate,
#                       alpha = LIFE_FLPOP_2020,
#                       size = LIFE_FLPOP_2020
#                       ),
#                   #size = 2, 
#                   #alpha = 1,
#                   #arrow = arrow(length = unit(0.03, "npc"), angle = 10, type='open', ends='last'),
#                   #arrow.fill = NULL, 
#                   linejoin = "mitre", lineend = "butt") +
#        scale_size(range = c(1, 2),
#                   limits = c(0, 500000)) +
#        scale_colour_viridis_c(
#                           limits = c(0.4, 1.5),    # quartile 에 맞게 변경!
#                           option = "viridis") +
#        scale_alpha(range = c(0.5, 1),
#                    limits = c(0, 500000)) +
#        theme_dark() +
#        theme(
#          panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#          legend.key.size = unit(1, 'cm'),
#          legend.key.height = unit(1, 'cm'), 
#          legend.key.width = unit(1, 'cm'), 
#          legend.title = element_text(size=10), 
#          legend.text = element_text(size=10),
#          plot.title = element_text(size = 1, face = "bold"),
#          legend.position = "right",
#          legend.box = "vertical") +
#            # + ggsn::blank()
#            
#    geom_sf(data = dong.sf_commune_resid_emp_forggplot %>%
#                  rotate_data(y_add = 0.4),
#              aes(fill = college),
#              size = 1, alpha = 0.3) +
#      #ggtitle("Destination") +
#        scale_fill_viridis(option = "magma", direction = -1) +
#        annotate("text", label = "origin", 
#                 #x = 4400000, y = 1770000, hjust = 0, 
#                 color="black") +
#        theme(legend.position = "none") # Clean Everything
#}
```

### whole
```{r fig.align="center", echo = FALSE, fig.width = 30, fig.height = 30}
#a <- flow_2020_2021_od_forggplot 
#
#visualize_two_layers(a)
```

### Q4
```{r fig.align="center", echo = FALSE, fig.width = 30, fig.height = 30}
#a <- flow_2020_2021_od_forggplot  %>%
#    filter(reducing_rate > quantile(reducing_rate, 0.75) & reducing_rate <= quantile(reducing_rate, 1))
#
#visualize_two_layers(a)
```

### Q3
```{r fig.align="center", echo = FALSE, fig.width = 30, fig.height = 30}
#a <- flow_2020_2021_od_forggplot %>%
#    filter(reducing_rate > quantile(reducing_rate, 0.5) & reducing_rate <= quantile(reducing_rate, 0.75))
#
#visualize_two_layers(a)
```

### Q2
```{r fig.align="center", echo = FALSE, fig.width = 30, fig.height = 30}
#a <- flow_2020_2021_od_forggplot %>%
#    filter(reducing_rate > quantile(reducing_rate, 0.25) & reducing_rate <= quantile(reducing_rate, 0.5))
#
#visualize_two_layers(a)
```

### Q1
```{r fig.align="center", echo = FALSE, fig.width = 30, fig.height = 30}
#a <- flow_2020_2021_od_forggplot %>%
#    filter(reducing_rate > quantile(reducing_rate, 0) & reducing_rate <= quantile(reducing_rate, 0.25))
#
#visualize_two_layers(a)
```

# --------
## reset your RAM
```{r}
#rm(flow_2020, flow_2021, flow_2020_2021, flow_2020_mat, flow_2021_mat, flow_2020_2021_od_forggplot,
#   list_of_maps_share, list_of_industries_share)
```

\
\

# -------------------------------------------------------
# -------------------------------------------------------
# -------------------------------------------------------
# making the longitudinal dataset
# ---------------------------
# stacking flow data
```{r}
#FI <- paste0("//192.168.0.22/Public/data_seoulmobility/", list.files(path = #"//192.168.0.22/Public/data_seoulmobility/"))
#FI
```

```{r}
#for (I in 1:length(FI)) {
#    print(I)
#    
#    fi <- as.character(FI[I])  
#    print(fi)
#    
#    fi_within <- paste0(fi, "/", list.files(path = fi))
#    #print(fi_within)
#    
#    for (i in 8:10) {
#        
#        print(fi_within[i])
#        
#        temp <- read_csv(as.character(fi_within[i]), locale=locale('ko',encoding='euc-kr'))
#    
#        colnames(temp) <- c("DEPRT_YM", "DAYOFWEEK", "DEPRT_HOUR", "DEPRTP", "DESTNTN", "GENDER", "AGE_GR", #"FLOW_TYPE", "TRVL_TIME", "LIFE_FLPOP")
#        
#        temp <- temp %>%
#            mutate_at(1:9, as.character) %>%
#            mutate(LIFE_FLPOP = replace(LIFE_FLPOP, LIFE_FLPOP=="*", "2")) %>%
#            mutate(LIFE_FLPOP = as.numeric(LIFE_FLPOP)) %>%
#            filter(str_sub(DEPRTP, 1, 2) == "11",
#                   str_sub(DESTNTN, 1, 2) == "11") %>%
#            filter(FLOW_TYPE == "HW") %>%
#            filter(DAYOFWEEK %in% c("월", "화", "수", "목", "금")) %>%
#            filter(as.numeric(AGE_GR) >= 20 & as.numeric(AGE_GR) < 60) 
#        
#        if (i == 8){
#          data <- plyr::rbind.fill(temp)
#          rm(temp) # 부산물 삭제
#        } else {
#          data <- plyr::rbind.fill(data, temp)
#          rm(temp) #부산물 삭제
#        }            
#        
#        #print(data)
#    }
#    
#    # edit flow data
#    data <- data %>%
#            group_by(DEPRTP, DESTNTN, GENDER, AGE_GR, TRVL_TIME) %>%                               
#            summarise(LIFE_FLPOP = sum(LIFE_FLPOP)) 
#
#    # save
#    # indexing
#    if (I < 10){
#          I <- as.character(paste0("0", I))
#        } else {
#          I <- as.character(I)
#        } 
#    # to files
#    data %>%
#        write_excel_csv(paste0("//192.168.0.22/Public/data_seoulmobility/data_seoul_mobility_abbreviated_0728/",
#                               I, 
#                               ".csv"))
#
#    rm(data)
#}
```

 
# ---------------------------
# stacking time-varying predictors
## import
```{r}
#FI <- paste0("//192.168.0.22/Public/data_seoul_mobility_abbreviated_0728/", 
#             list.files(path = "//192.168.0.22/Public/data_seoul_mobility_abbreviated_0728/"))
#FI
```

## binding rows
```{r}
#for (I in 1:length(FI)) {      # in 1:length(FI) 임을 잊지말것
#    print(I)
#     
#    temp <- read_csv(as.character(FI[I]), locale=locale('ko', encoding = 'UTF-8'))
#    
#    if (I == 1){     
#        ## aggregate to community
#        temp <- temp  %>%
#            mutate(DEPRTP = as.character(DEPRTP),
#                   DESTNTN = as.character(DESTNTN)) %>%
#            left_join(membership_info_eng, by = c("DEPRTP" = "ADM_CD")) %>%
#            left_join(membership_info_eng, by = c("DESTNTN" = "ADM_CD")) %>%
#            group_by(member_eng.x, member_eng.y, GENDER, AGE_GR, TRVL_TIME) %>%
#            summarise(LIFE_FLPOP = sum(LIFE_FLPOP))     # 커뮤니티 단위로 합역한 이후 링크수는 112,540개에서 #3599개로 
#        temp <- temp  %>%
#            ungroup() %>%
#            select(member_eng.x, member_eng.y, GENDER, AGE_GR, TRVL_TIME, LIFE_FLPOP) %>%
#            rename(home = member_eng.x,
#                   work = member_eng.y)
#        
#        ## by_gender
#        by_gender <- temp %>%
#            ungroup() %>%
#            group_by(home, work) %>%
#            mutate(LIFE_FLPOP_linktotal = sum(LIFE_FLPOP, na.rm = T)) %>%
#            
#            ungroup() %>%
#            group_by(home, work, GENDER) %>%
#            summarise(by_gender = sum(LIFE_FLPOP, na.rm = T),
#                      LIFE_FLPOP_linktotal = mean(LIFE_FLPOP_linktotal, na.rm = T)) %>%
#            
#            mutate(by_gender = by_gender / LIFE_FLPOP_linktotal * 100) %>%
#            #select(-LIFE_FLPOP_linktotal) %>%
#        
#            pivot_wider(names_from = GENDER, values_from = by_gender) %>%
#            select(home, work, `F`, LIFE_FLPOP_linktotal) %>% 
#            rename(female = `F`,
#                   flow = LIFE_FLPOP_linktotal)
#        
#        ## by_agegroup
#        by_agegroup <- temp %>%
#            ungroup() %>%
#            group_by(home, work) %>%
#            mutate(LIFE_FLPOP_linktotal = sum(LIFE_FLPOP, na.rm = T)) %>%
#            
#            ungroup() %>%
#            group_by(home, work, AGE_GR) %>%
#            summarise(by_agegroup = sum(LIFE_FLPOP, na.rm = T),
#                      LIFE_FLPOP_linktotal = mean(LIFE_FLPOP_linktotal, na.rm = T)) %>%
#            
#            mutate(by_agegroup = by_agegroup / LIFE_FLPOP_linktotal) %>%
#            select(home, work, AGE_GR, by_agegroup) %>%
#            
#            pivot_wider(names_from = AGE_GR, values_from = by_agegroup) %>%
#            select(`20`, `25`, `30`, `35`) %>%    
#            
#            mutate(`20` = replace_na(`20`, 0),
#                   `25` = replace_na(`25`, 0),
#                   `30` = replace_na(`30`, 0),
#                   `35` = replace_na(`35`, 0)) %>%
#            mutate(agegroup_2030 = (`20`+`25`+`30`+`35`) * 100) %>%
#            select(home, work, agegroup_2030)
#        
#        ## by_traveltime
#        by_traveltime <- temp  %>%
#            ungroup() %>%
#            group_by(home, work) %>%
#            summarise(average_traveltime = weighted.mean(TRVL_TIME, LIFE_FLPOP))
#        
#        ## merge
#        temp <- by_gender %>%
#            left_join(by_agegroup, by = c("home", "work"))  %>%
#            left_join(by_traveltime, by = c("home", "work")) %>%
#            relocate(home, work, flow, female, agegroup_2030, average_traveltime) %>%
#            mutate(Time = str_c(I))
#        head(temp)
#
#        data <- temp 
#          rm(temp, by_gender, by_agegroup, by_traveltime) # 부산물 삭제
#          print("here")
#          
#        } else {
#        ## aggregate to community
#        temp <- temp  %>%
#            mutate(DEPRTP = as.character(DEPRTP),
#                   DESTNTN = as.character(DESTNTN)) %>%
#            left_join(membership_info_eng, by = c("DEPRTP" = "ADM_CD")) %>%
#            left_join(membership_info_eng, by = c("DESTNTN" = "ADM_CD")) %>%
#            group_by(member_eng.x, member_eng.y, GENDER, AGE_GR, TRVL_TIME) %>%
#            summarise(LIFE_FLPOP = sum(LIFE_FLPOP))     # 커뮤니티 단위로 합역한 이후 링크수는 112,540개에서 #3599개로 
#        temp <- temp  %>%
#            ungroup() %>%
#            select(member_eng.x, member_eng.y, GENDER, AGE_GR, TRVL_TIME, LIFE_FLPOP) %>%
#            rename(home = member_eng.x,
#                   work = member_eng.y)
#        
#        ## by_gender
#        by_gender <- temp %>%
#            ungroup() %>%
#            group_by(home, work) %>%
#            mutate(LIFE_FLPOP_linktotal = sum(LIFE_FLPOP, na.rm = T)) %>%
#            
#            ungroup() %>%
#            group_by(home, work, GENDER) %>%
#            summarise(by_gender = sum(LIFE_FLPOP, na.rm = T),
#                      LIFE_FLPOP_linktotal = mean(LIFE_FLPOP_linktotal, na.rm = T)) %>%
#            
#            mutate(by_gender = by_gender / LIFE_FLPOP_linktotal * 100) %>%
#            #select(-LIFE_FLPOP_linktotal) %>%
#        
#            pivot_wider(names_from = GENDER, values_from = by_gender) %>%
#            select(home, work, `F`, LIFE_FLPOP_linktotal) %>% 
#            rename(female = `F`,
#                   flow = LIFE_FLPOP_linktotal)
#        
#        ## by_agegroup
#        by_agegroup <- temp %>%
#            ungroup() %>%
#            group_by(home, work) %>%
#            mutate(LIFE_FLPOP_linktotal = sum(LIFE_FLPOP, na.rm = T)) %>%
#            
#            ungroup() %>%
#            group_by(home, work, AGE_GR) %>%
#            summarise(by_agegroup = sum(LIFE_FLPOP, na.rm = T),
#                      LIFE_FLPOP_linktotal = mean(LIFE_FLPOP_linktotal, na.rm = T)) %>%
#            
#            mutate(by_agegroup = by_agegroup / LIFE_FLPOP_linktotal) %>%
#            select(home, work, AGE_GR, by_agegroup) %>%
#            
#            pivot_wider(names_from = AGE_GR, values_from = by_agegroup) %>%
#            select(`20`, `25`, `30`, `35`) %>%    
#            
#            mutate(`20` = replace_na(`20`, 0),
#                   `25` = replace_na(`25`, 0),
#                   `30` = replace_na(`30`, 0),
#                   `35` = replace_na(`35`, 0)) %>%
#            mutate(agegroup_2030 = (`20`+`25`+`30`+`35`) * 100) %>%
#            select(home, work, agegroup_2030)
#        
#        ## by_traveltime
#        by_traveltime <- temp  %>%
#            ungroup() %>%
#            group_by(home, work) %>%
#            summarise(average_traveltime = weighted.mean(TRVL_TIME, LIFE_FLPOP))
#        
#        ## merge
#        temp <- by_gender %>%
#            left_join(by_agegroup, by = c("home", "work"))  %>%
#            left_join(by_traveltime, by = c("home", "work")) %>%
#            relocate(home, work, flow, female, agegroup_2030, average_traveltime) %>%
#            mutate(Time = str_c(I))
#        head(temp)
#        
#        data <- data %>%
#              dplyr::bind_rows(temp)
#          rm(temp, by_gender, by_agegroup, by_traveltime) #부산물 삭제
#          print("here")
#        }
#}
```

```{r}
#data %>%
#    write_excel_csv("data_longitudinal/flow_30months_0728.csv")
```

# ---------------------------
# joining time-varying predictors
## set up
```{r}
data <- read_csv("data_longitudinal/flow_30months_0728.csv")
data <- data %>% 
    mutate(hw_link = str_c(home, " -> ", work)) 
data
```

```{r}
data <- data %>%
    mutate(Time_ts = case_when(Time == "1" ~  "2020-01-01",
                            Time == "2" ~  "2020-02-01",
                            Time == "3" ~  "2020-03-01",
                            Time == "4" ~  "2020-04-01",
                            Time == "5" ~  "2020-05-01",
                            Time == "6" ~  "2020-06-01",
                            Time == "7" ~  "2020-07-01",
                            Time == "8" ~  "2020-08-01",
                            Time == "9" ~  "2020-09-01",
                            Time == "10" ~ "2020-10-01",
                            Time == "11" ~ "2020-11-01",
                            Time == "12" ~ "2020-12-01",
                            Time == "13" ~ "2021-01-01",
                            Time == "14" ~ "2021-02-01",
                            Time == "15" ~ "2021-03-01",
                            Time == "16" ~ "2021-04-01",
                            Time == "17" ~ "2021-05-01",
                            Time == "18" ~ "2021-06-01",
                            Time == "19" ~ "2021-07-01",
                            Time == "20" ~ "2021-08-01",
                            Time == "21" ~ "2021-09-01",
                            Time == "22" ~ "2021-10-01",
                            Time == "23" ~ "2021-11-01",
                            Time == "24" ~ "2021-12-01",
                            Time == "25" ~ "2022-01-01",
                            Time == "26" ~ "2022-02-01",
                            Time == "27" ~ "2022-03-01",
                            Time == "28" ~ "2022-04-01",
                            Time == "29" ~ "2022-05-01",
                            Time == "30" ~ "2022-06-01",
                            )) %>%
    mutate(Time_ts = as.character(Time_ts)) %>%
    #arrange(home, work) %>%
    mutate(Time_ts = tsibble::yearmonth(as.Date(Time_ts))) %>%
    relocate(Time_ts) 
data
```

## filter out thin links 
```{r fig.align="center", echo = FALSE,fig.width = 20, fig.height = 20}
#data %>%
#    mutate(Time_ts = factor(Time_ts)) %>%
#    ggplot(aes(x = flow)) +
#    geom_histogram() +
#    facet_wrap(vars(Time_ts))
```

```{r fig.align="center", echo = FALSE,fig.width = 20, fig.height = 20}
#data %>%
#    filter(home != work) %>%
#    mutate(Time_ts = factor(Time_ts)) %>%
#    ggplot(aes(x = flow)) +
#    geom_histogram() +
#    facet_wrap(vars(Time_ts))
```

```{r}
# 특정 성별이 집계되지 않아 여성비율이 결측치로 도출되는 너무 얇은 링크는 제외함.
#data %>%
#    filter(is.na(female)) %>%
#    DT::datatable()
```

```{r}
# outlier 제거 위해 좀 더 엄정한 기준 적용
# 28개월동안의 평균치가 일정 기준 이하인 것을 찾도록 함
# 중간에 끊기는 것을 방지하기 위해 얇은 링크는 전 시점에 대해 지우도록 함
data_filtered <- data %>%
    group_by(hw_link) %>%
    mutate(flow_mean = mean(flow)) %>%
    ungroup() %>%                                    # 중요함
    filter(flow_mean > quantile(flow_mean, 0.25))
data_filtered
```

```{r}
#data_filtered %>%
#    group_by(hw_link)
# 1950 * 28 = 54600
```

# ---------------------------
# joining time-invariant predictors
# -----------
## import
### residential mode
```{r}
resid_mode 
```

### employment mode
```{r}
emp_mode
```

# -----------
## join
```{r}
data_filtered_resid_emp <- data_filtered %>%
    left_join(resid_mode, by = c("home" = "member_eng")) %>%
    left_join(emp_mode, by = c("work" = "member_eng")) %>%
    relocate(Time, hw_link, flow,
             resid_size, college,
             emp_size, cluster, share_of_KIBS,
             home, work)
data_filtered_resid_emp
```

```{r}
data_filtered_resid_emp %>%
    group_by(hw_link)
```

# -----------
## internal communte
```{r}
data_filtered_resid_emp <- data_filtered_resid_emp %>%
    mutate(internal = if_else(home == work, 1, 0)) %>%
    mutate(internal = factor(internal)) %>%
    relocate(Time, hw_link, flow, internal,
             resid_size, college,
             emp_size, cluster, share_of_KIBS,
             home, work)
data_filtered_resid_emp
```

# -----------
## export
```{r}
data_filtered_resid_emp %>%
    write_excel_csv("data_longitudinal/data_filtered_resid_emp.csv")
```


\
\

# -------------------------------------------------------
# -------------------------------------------------------
# -------------------------------------------------------
# EDA
# ---------------------------
## time window
### import data
```{r}
data_filtered_resid_emp <- read_csv("data_longitudinal/data_filtered_resid_emp.csv")
```

### set up as tsibble
```{r}
data_filtered_resid_emp_ts <- data_filtered_resid_emp %>%
    mutate(Time_ts = yearmonth(Time_ts)) %>%
    tsibble::as_tsibble(index = Time_ts, key = hw_link) %>%
    relocate(Time_ts, hw_link)
data_filtered_resid_emp_ts <- data_filtered_resid_emp_ts %>%
    mutate(cluster = factor(cluster),
           internal = factor(internal))
data_filtered_resid_emp_ts 
```

# -----------
## entire period
```{r}
data_filtered_resid_emp_ts <-data_filtered_resid_emp_ts %>%
    mutate(college_quartile = case_when(
        quantile(college, 0.75) < college ~ "high",
        quantile(college, 0.50) < college & college <= quantile(college, 0.75) ~ "medium_high",
        quantile(college, 0.25) < college & college <= quantile(college, 0.50) ~ "medium_low",
        college <= quantile(college, 0.25) ~ "low"))
data_filtered_resid_emp_ts
```

```{r fig.align="center", echo = FALSE,fig.width = 18, fig.height = 13}
data_filtered_resid_emp_ts %>%
    filter(home != work) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(x = Time_ts, y = flow)) +
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "point", size = 5) +

    stat_summary(fun.y = mean, color = 'black', size = 1, geom = 'line') +
      scale_y_continuous(name = "mean flow volume") 
```

```{r fig.align="center", echo = FALSE,fig.width = 18, fig.height = 13}
data_filtered_resid_emp_ts %>%
    filter(home != work) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(x = Time_ts, y = log(flow))) +
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "point", size = 5) +

    stat_summary(fun.y = mean, color = 'black', size = 1, geom = 'line') +
      scale_y_continuous(name = "mean flow volume") 
```

# -----------
## window cut
```{r}
data_filtered_resid_emp_ts %>%
    as_tibble() %>%
    ungroup() %>%
    group_by(Time_ts) %>%
    summarise(mean(flow))
```

```{r}
data_filtered_resid_emp_ts %>%
    as_tibble() %>%
    select(Time_ts) %>%
    distinct() %>%
    as.vector()
```

### spline_1
```{r fig.align="center", echo = FALSE,fig.width = 8, fig.height = 10}
data_filtered_resid_emp_ts %>%
    filter(home != work) %>%
    filter(as.character(Time_ts) %in% c("2020 Jan", "2020 Feb", "2020 Mar", "2020 Apr", "2020 May", "2020 Jun", "2020 Jul")) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(x = Time_ts, y = log(flow))) +
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "point", size = 5) +

    stat_summary(fun.y = mean, color = 'black', size = 1, geom = 'line') +
      scale_y_continuous(name = "mean flow volume") 
```

### spline_2
```{r fig.align="center", echo = FALSE,fig.width = 8, fig.height = 10}
data_filtered_resid_emp_ts %>%
    filter(home != work) %>%
    filter(as.character(Time_ts) %in% c("2020 Jul", "2020 Aug", "2020 Sep", "2020 Oct", "2020 Nov")) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(x = Time_ts, y = log(flow))) +
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "point", size = 5) +

    stat_summary(fun.y = mean, color = 'black', size = 1, geom = 'line') +
      scale_y_continuous(name = "mean flow volume") 
```

### spline_3
```{r fig.align="center", echo = FALSE,fig.width = 8, fig.height = 10}
data_filtered_resid_emp_ts %>%
    filter(home != work) %>%
    filter(as.character(Time_ts) %in% c("2021 Jun","2021 Jul", "2021 Aug", "2021 Sep", "2021 Oct", "2021 Nov", "2021 DEC")) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(x = Time_ts, y = log(flow))) +
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "point", size = 5) +

    stat_summary(fun.y = mean, color = 'black', size = 1, geom = 'line') +
      scale_y_continuous(name = "mean flow volume") 
```

### spline_4
```{r fig.align="center", echo = FALSE,fig.width = 8, fig.height = 10}
data_filtered_resid_emp_ts %>%
    filter(home != work) %>%
    filter(as.character(Time_ts) %in% c("2021 Dec", "2022 Jan", "2022 Feb", "2022 Mar", "2022 Apr")) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(x = Time_ts, y = log(flow))) +
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "point", size = 5) +

    stat_summary(fun.y = mean, color = 'black', size = 1, geom = 'line') +
      scale_y_continuous(name = "mean flow volume") 
```


# ---------------------------
# possibility of interaction effect
# -----------
## ex) spline_2 
### flow data
wave2 : 2020 Jul ~ 2020 Nov as example
```{r}
data_filtered_resid_emp_ts_timewindow <- data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2020 Jul", "2020 Aug", "2020 Sep", "2020 Oct", "2020 Nov")) 
 
data_filtered_resid_emp_ts_timewindow 
```

```{r}
data_filtered_resid_emp_ts_timewindow_wave2_202007 <- data_filtered_resid_emp_ts_timewindow %>%
    filter(as.character(Time_ts) == "2020 Jul") %>%
    as_tibble() %>%
    select(home, work, flow, average_traveltime, cluster, college, share_of_KIBS, college_quartile)

data_filtered_resid_emp_ts_timewindow_wave2_202008 <- data_filtered_resid_emp_ts_timewindow %>%
    filter(as.character(Time_ts) == "2020 Aug") %>%
    as_tibble() %>%
    select(home, work, flow, average_traveltime, college, share_of_KIBS, college_quartile)

data_filtered_resid_emp_ts_timewindow_wave2_202011 <- data_filtered_resid_emp_ts_timewindow %>%
    filter(as.character(Time_ts) == "2020 Nov") %>%
    as_tibble() %>%
    select(home, work, flow, average_traveltime, college, share_of_KIBS, college_quartile)
```


```{r}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 <- data_filtered_resid_emp_ts_timewindow_wave2_202007 %>%
    left_join(data_filtered_resid_emp_ts_timewindow_wave2_202008, by = c("home", "work"), suffix = c("_202007", "_202008")) %>%
    left_join(data_filtered_resid_emp_ts_timewindow_wave2_202011, by = c("home", "work")) %>%
    rename(flow_202011 = flow,
           average_traveltime_202011 = average_traveltime) %>%
    relocate(home, work, cluster)

data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 <- data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 %>%
    mutate(diminish_rate_07_08 = flow_202008 / flow_202007,
           recovery_rate_08_11 = flow_202011 / flow_202008)
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11
```

```{r}
rm(data_filtered_resid_emp_ts_timewindow_wave3_202007,
   data_filtered_resid_emp_ts_timewindow_wave3_202008,
   data_filtered_resid_emp_ts_timewindow_wave3_202011)
```

```{r}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 %>% select(diminish_rate_07_08) %>% arrange(diminish_rate_07_08)
```

```{r}
# 15개 정도를 제외하면 모두 1.0 미만의 감소율을 보임.
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 %>% select(diminish_rate_07_08) %>% arrange(desc(diminish_rate_07_08))
```

### scatter plot
```{r fig.align="center", echo = FALSE,fig.width = 20, fig.height = 20}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(flow_202007, cluster, college, share_of_KIBS, diminish_rate_07_08, recovery_rate_08_11) %>%
    ggplot(aes(x = college, y = cluster, size = flow_202007)) +
    geom_jitter(aes(col = diminish_rate_07_08*100), alpha = 0.5) +
    scale_size(range = c(5, 20)) +
    scale_colour_viridis_c(limits = c(40, 100)) 
```

```{r fig.align="center", echo = FALSE,fig.width = 20, fig.height = 20}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(flow_202007, cluster, college, share_of_KIBS, diminish_rate_07_08, recovery_rate_08_11) %>%
    ggplot(aes(x = college, y = share_of_KIBS, size = flow_202007)) +
    geom_jitter(aes(col = diminish_rate_07_08*100), alpha = 0.5) +
    scale_size(range = c(5, 20)) +
    scale_colour_viridis_c(limits = c(40, 100)) 
```

### heatmap
```{r fig.align="center", echo = FALSE,fig.width = 20, fig.height = 20}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(home, work, college, share_of_KIBS, diminish_rate_07_08) %>%
    relocate(home, work, diminish_rate_07_08) %>%
    
    arrange(college) %>%
    mutate(college_fct = 
               forcats::fct_inorder(factor
                                    (round(college, 3), ordered = TRUE))) %>%
    
    arrange(share_of_KIBS) %>%
    mutate(share_of_KIBS_fct = 
               forcats::fct_inorder(factor
                                    (round(share_of_KIBS,3), ordered = TRUE)))
```

```{r fig.align="center", echo = FALSE,fig.width = 20, fig.height = 20}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(home, work, college, share_of_KIBS, diminish_rate_07_08) %>%
    relocate(home, work, diminish_rate_07_08) %>%
    
    arrange(college) %>%
    mutate(college_fct = 
               forcats::fct_inorder(factor
                                    (round(college, 3), ordered = TRUE))) %>%
    
    arrange(share_of_KIBS) %>%
    mutate(share_of_KIBS_fct = 
               forcats::fct_inorder(factor
                                    (round(share_of_KIBS,3), ordered = TRUE))) %>%
    
    ggplot(aes(x = college_fct, y = share_of_KIBS_fct, fill = diminish_rate_07_08 * 100)) +
    geom_tile() +
    scale_fill_viridis(discrete = FALSE, limits = c(50, 100)) 
```

data_filtered_resid_emp_ts
```{r fig.align="center", echo = FALSE,fig.width = 10, fig.height = 10}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(home, work, college, share_of_KIBS, diminish_rate_07_08, college_quartile, cluster) %>%
    relocate(home, work, diminish_rate_07_08) %>%

    arrange(college_quartile) %>%
    mutate(college_quartile_fct = 
               factor(college_quartile, levels = c("low", "medium_low",
                                                            "medium_high", "high"))) %>%
    
    arrange(cluster) %>%
    mutate(cluster_fct = 
               forcats::fct_inorder(factor
                                    (cluster, ordered = TRUE))) %>%
    
    ggplot(aes(x = college_quartile_fct, y =cluster_fct, fill = diminish_rate_07_08 * 100)) +
    geom_tile() +
    scale_fill_viridis(discrete = FALSE, limits = c(50, 100)) 
```

# -----------
## ex) spline_3
### flow data
wave3 : 2021 Jun ~ 2021 Dec as example
```{r}
data_filtered_resid_emp_ts_timewindow <- data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2021 Jun","2021 Jul", "2021 Aug", "2021 Sep", "2021 Oct", "2021 Nov", "2021 Dec")) 
 
data_filtered_resid_emp_ts_timewindow 
# 1950 * 7 = 13650
```

```{r}
data_filtered_resid_emp_ts_timewindow_wave3_202106 <- data_filtered_resid_emp_ts_timewindow %>%
    filter(as.character(Time_ts) == "2021 Jun") %>%
    as_tibble() %>%
    select(home, work, flow, average_traveltime, cluster, college, share_of_KIBS)

data_filtered_resid_emp_ts_timewindow_wave3_202109 <- data_filtered_resid_emp_ts_timewindow %>%
    filter(as.character(Time_ts) == "2021 Sep") %>%
    as_tibble() %>%
    select(home, work, flow, average_traveltime, cluster, college, share_of_KIBS)

data_filtered_resid_emp_ts_timewindow_wave3_202112 <- data_filtered_resid_emp_ts_timewindow %>%
    filter(as.character(Time_ts) == "2021 Dec") %>%
    as_tibble() %>%
    select(home, work, flow, average_traveltime, cluster, college, share_of_KIBS)
```

```{r}
data_filtered_resid_emp_ts_timewindow_wave3_202106_09_12 <- data_filtered_resid_emp_ts_timewindow_wave3_202106 %>%
    left_join(data_filtered_resid_emp_ts_timewindow_wave3_202109, by = c("home", "work"), suffix = c("_202106", "_202109")) %>%
    left_join(data_filtered_resid_emp_ts_timewindow_wave3_202112, by = c("home", "work")) %>%
    rename(flow_202112 = flow,
           average_traveltime_202112 = average_traveltime) %>%
    relocate(home, work, cluster) %>%
    select(home, work, 
           college,
           share_of_KIBS, cluster,
           flow_202106, flow_202109, flow_202112)

data_filtered_resid_emp_ts_timewindow_wave3_202106_09_12 <- data_filtered_resid_emp_ts_timewindow_wave3_202106_09_12 %>%
    mutate(diminish_rate_06_09 = flow_202109 / flow_202106,
           recovery_rate_09_12 = flow_202112 / flow_202109)
data_filtered_resid_emp_ts_timewindow_wave3_202106_09_12
```

```{r}
rm(data_filtered_resid_emp_ts_timewindow_wave3_202106,
   data_filtered_resid_emp_ts_timewindow_wave3_202109,
   data_filtered_resid_emp_ts_timewindow_wave3_202112)
```

```{r}
data_filtered_resid_emp_ts_timewindow_wave3_202106_09_12 %>% select(home, work, diminish_rate_06_09) %>% arrange(diminish_rate_06_09)
```

```{r}
# 50개 정도를 제외하면 모두 1.0 미만의 감소율을 보임.
data_filtered_resid_emp_ts_timewindow_wave3_202106_09_12 %>% select(home, work, diminish_rate_06_09) %>% arrange(desc(diminish_rate_06_09))
```

### scatterplot
```{r fig.align="center", echo = FALSE,fig.width = 20, fig.height = 20}
data_filtered_resid_emp_ts_timewindow_wave3_202106_09_12 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(flow_202106, cluster, college, share_of_KIBS, diminish_rate_06_09, recovery_rate_09_12) %>%
    ggplot(aes(x = college, y = cluster, size = flow_202106)) +
    geom_jitter(aes(col = diminish_rate_06_09*100), alpha = 0.5) +
    scale_size(range = c(5, 20)) +
    scale_colour_viridis_c(limits = c(50, 100)) 
```

```{r fig.align="center", echo = FALSE,fig.width = 20, fig.height = 20}
data_filtered_resid_emp_ts_timewindow_wave3_202106_09_12 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(flow_202106, cluster, college, share_of_KIBS, diminish_rate_06_09, recovery_rate_09_12) %>%
    ggplot(aes(x = college, y = share_of_KIBS, size = flow_202106)) +
    geom_jitter(aes(col = diminish_rate_06_09*100), alpha = 0.5) +
    scale_size(range = c(5, 20)) +
    scale_colour_viridis_c(limits = c(50, 100)) 
```

### heatmap
```{r fig.align="center", echo = FALSE,fig.width = 20, fig.height = 20}
data_filtered_resid_emp_ts_timewindow_wave3_202106_09_12 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(home, work, college, share_of_KIBS, diminish_rate_06_09) %>%
    relocate(home, work, diminish_rate_06_09) %>%
    
    arrange(college) %>%
    mutate(college_fct = 
               forcats::fct_inorder(factor
                                    (round(college, 3), ordered = TRUE))) %>%
    
    arrange(share_of_KIBS) %>%
    mutate(share_of_KIBS_fct = 
               forcats::fct_inorder(factor
                                    (round(share_of_KIBS,3), ordered = TRUE)))
```

```{r fig.align="center", echo = FALSE,fig.width = 20, fig.height = 20}
data_filtered_resid_emp_ts_timewindow_wave3_202106_09_12 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(home, work, college, share_of_KIBS, diminish_rate_06_09) %>%
    relocate(home, work, diminish_rate_06_09) %>%
    
    arrange(college) %>%
    mutate(college_fct = 
               forcats::fct_inorder(factor
                                    (round(college, 3), ordered = TRUE))) %>%
    
    arrange(share_of_KIBS) %>%
    mutate(share_of_KIBS_fct = 
               forcats::fct_inorder(factor
                                    (round(share_of_KIBS,3), ordered = TRUE))) %>%
    
    ggplot(aes(x = college_fct, y = share_of_KIBS_fct, fill = diminish_rate_06_09 * 100)) +
    geom_tile() +
    scale_fill_viridis(discrete = FALSE, limits = c(50, 100)) 
```

\
\

# -------------------------------------------------------
# -------------------------------------------------------
# -------------------------------------------------------
# lme4 for longitudinal models(rescaled)
```{r}
library(lme4)
```

# ---------------------------
# model buildup
```{r}
set_theme(base = theme_grey(),
          geom.alpha = 1)
```

# -----------
## proper data structure
ex) spline_2 
### import - window cut - visualization
```{r}
data_filtered_resid_emp_ts_timewindow <- data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2020 Jul", "2020 Aug", "2020 Sep", "2020 Oct", "2020 Nov")) 
data_filtered_resid_emp_ts_timewindow 
```

### logged - centered and scaled
```{r}
data_filtered_resid_emp_ts_timewindow_logged_centered <- data_filtered_resid_emp_ts_timewindow %>%
    mutate(log_house_price = log(house_price)) %>%
    mutate(log_resid_size = log(resid_size)) %>%
    mutate(log_emp_size = log(emp_size)) %>%    
    mutate(female = scale(female, center = TRUE, scale = TRUE),
           agegroup_2030 = scale(agegroup_2030, center = TRUE, scale = TRUE),
           average_traveltime = scale(average_traveltime, center = TRUE, scale = TRUE),
           one_person_household = scale(one_person_household, center = TRUE, scale = TRUE),
           college = scale(college, center = TRUE, scale = TRUE),
           log_house_price = scale(log_house_price, center = TRUE, scale = TRUE),
           log_emp_size = scale(log_emp_size, center = TRUE, scale = TRUE),
           log_resid_size = scale(log_resid_size, center = TRUE, scale = TRUE))
data_filtered_resid_emp_ts_timewindow_logged_centered
```

### zeroed
```{r}
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed <-
    data_filtered_resid_emp_ts_timewindow_logged_centered %>%
    mutate(Time = Time - 7)
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed 
```

# -----------
## analysis 
```{r}
knot = 1

data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled <- 
    data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed %>%
    mutate(pre_knot_time = pmin(0, Time-knot),
           post_knot_time = pmax(0, Time-knot))
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled
```

### 1 : basic LDA model
$$
\begin{align}
Level 1 \\

Flow_{ti} &= b_{0i} + b_{1i}min(t-knot,0) + b_{2i}max(t-knot,0) + u_{ti} \\

\\                                                                                                                                                                  
\\

Level 2 \\
b_{0i} &= \beta_{00} + \gamma_{0i} \\
b_{1i} &= \beta_{10} + \gamma_{1i} \\
b_{2i} &= \beta_{20} + \gamma_{2i} \\
\end{align}
$$

```{r}
sp_2_RCC_knot <- lme4::lmer(flow ~ 
                                # fixed effect
                                pre_knot_time + post_knot_time + 
                                
                                # random effect
                                (1|hw_link) + (-1 + pre_knot_time|hw_link) + (-1 + post_knot_time|hw_link),
                            data = data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled)
summary(sp_2_RCC_knot)
```

### 2 : gravitational model
$$
\begin{align}
Level 1 \\

Flow_{ti} &= b_{0i} + b_{1i}min(t-knot,0) + b_{2i}max(t-knot,0) + u_{ti} \\

\\                                                                                                                                                                  
\\

Level 2 \\
b_{0i} &= \beta_{00} + \beta_{01}\mathrm{log}(ResidSize) + \beta_{02}\mathrm{log}(EmpSize) + \beta_{03}TravelTimeDist + \beta_{04}InternalCommute + \gamma_{0i} \\

b_{1i} &= \beta_{10} + \beta_{11}\mathrm{log}(ResidSize) + \beta_{12}\mathrm{log}(EmpSize) + \gamma_{1i} \\

b_{2i} &= \beta_{20} + \beta_{11}\mathrm{log}(ResidSize) + \beta_{22}\mathrm{log}(EmpSize) + \gamma_{2i} \\
\end{align}
$$

```{r}
sp_2_RCC_knot_grav <- lme4::lmer(flow ~ 
                                    
                                    # grav 
                                    (pre_knot_time + post_knot_time) * log_emp_size +
                                    (pre_knot_time + post_knot_time) * log_resid_size + 
                                    average_traveltime + internal +      
                                     
                                     # random effect
                                    (1|hw_link) + (-1 + pre_knot_time|hw_link) + (-1 + post_knot_time|hw_link), 
                       data = data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled)
summary(sp_2_RCC_knot_grav)
```

### 3 : education and industry as explanatory factors
$$
\begin{align}
Level 1 \\

Flow_{ti} &= b_{0i} + b_{1i}min(t-knot,0) + b_{2i}max(t-knot,0) + u_{ti} \\

\\                                                                                                                                                                  
\\

Level 2 \\
b_{0i} &= \beta_{00} + \beta_{01}\mathrm{log}(ResidSize) + \beta_{02}\mathrm{log}(EmpSize) + \beta_{03}TravelTimeDist + \beta_{04}InternalCommute + \gamma_{0i} \\

b_{1i} &= \beta_{10} + \beta_{11}\mathrm{log}(ResidSize) + \beta_{12}\mathrm{log}(EmpSize) + \beta_{13}College + \beta_{14}Cluster + \gamma_{1i} \\

b_{2i} &= \beta_{20} + \beta_{21}\mathrm{log}(ResidSize) + \beta_{22}\mathrm{log}(EmpSize) + \beta_{23}College + \beta_{24}Cluster+ \gamma_{2i} \\

\end{align}
$$

```{r}
sp_2_RCC_knot_grav_EduIndustry <- lme4::lmer(flow ~ 
                                    
                                    # grav                                                 
                                    (pre_knot_time + post_knot_time) * log_emp_size +
                                    (pre_knot_time + post_knot_time) * log_resid_size +
                                    average_traveltime + internal +
                                        
                                    # education and industry        
                                    (pre_knot_time + post_knot_time) * cluster +
                                    (pre_knot_time + post_knot_time) * college +
                                    
                                    # random effect
                                    (1|hw_link) + (-1 + pre_knot_time|hw_link) + (-1 + post_knot_time|hw_link), 
                       data = data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled)
summary(sp_2_RCC_knot_grav_EduIndustry)
```

### 4 : education and industry and their interactions 
$$
\begin{align}
Level 1 \\

Flow_{ti} &= b_{0i} + b_{1i}min(t-knot,0) + b_{2i}max(t-knot,0) + u_{ti} \\

\\                                                                                                                                                                  
\\

Level 2 \\
b_{0i} &= \beta_{00} + \beta_{01}\mathrm{log}(ResidSize) + \beta_{02}\mathrm{log}(EmpSize) + \beta_{03}TravelTimeDist + \beta_{04}InternalCommute + \gamma_{0i} \\

b_{1i} &= \beta_{10} + \beta_{11}\mathrm{log}(ResidSize) + \beta_{12}\mathrm{log}(EmpSize) + \beta_{13}College + \beta_{14}Cluster + \beta_{15}CollegeCluster + \gamma_{1i} \\

b_{2i} &= \beta_{20} + \beta_{21}\mathrm{log}(ResidSize) + \beta_{22}\mathrm{log}(EmpSize) + \beta_{23}College + \beta_{24}Cluster + \beta_{25}CollegeCluster + \gamma_{2i} \\

\end{align}
$$

```{r}
sp_2_RCC_knot_grav_EduIndustry_interact <- lme4::lmer(flow ~ 
                                    
                                    # grav                                                 
                                    (pre_knot_time + post_knot_time) * log_emp_size +
                                    (pre_knot_time + post_knot_time) * log_resid_size +
                                    average_traveltime + internal +
                                        
                                    # education and industry        
                                    (pre_knot_time + post_knot_time) * cluster*college +
                                    
                                    # random effect
                                    (1|hw_link) + (-1 + pre_knot_time|hw_link) + (-1 + post_knot_time|hw_link), 
                       data = data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled)
summary(sp_2_RCC_knot_grav_EduIndustry_interact)
```

# -----------
## tab model  
```{r}
pl <- c(
# at the baseline : knot    
`(Intercept)` = "Intercept",
internal1 = "internal commute",
log_emp_size = "log(emp size)",
log_resid_size = "log(res size)",
average_traveltime = "travel time distance",
college = "college",
`cluster2` = "cluster 2",
`cluster3` = "cluster 3",  
`cluster4` = "cluster 4",
`cluster5` = "cluster 5",
`cluster6` = "cluster 6",
`cluster2:college` = "cluster 2 : college",
`cluster3:college` = "cluster 3 : college",  
`cluster4:college` = "cluster 4 : college",
`cluster5:college` = "cluster 5 : college",
`cluster6:college` = "cluster 6 : college",

# pre-knot
`pre_knot_time` = "pre-knot-time",
`pre_knot_time:log_emp_size`  = "pre-knot-time : log(emp size)",
`pre_knot_time:log_resid_size`  = "pre-knot-time : log(res size)",
`pre_knot_time:college` = "pre-knot-time : college",
`pre_knot_time:cluster2` = "pre-knot-time : cluster 2",
`pre_knot_time:cluster3` = "pre-knot-time : cluster 3",  
`pre_knot_time:cluster4` = "pre-knot-time : cluster 4",
`pre_knot_time:cluster5` = "pre-knot-time : cluster 5",
`pre_knot_time:cluster6` = "pre-knot-time : cluster 6",
`pre_knot_time:cluster2:college` = "pre-knot-time : cluster 2 : college",
`pre_knot_time:cluster3:college` = "pre-knot-time : cluster 3 : college",  
`pre_knot_time:cluster4:college` = "pre-knot-time : cluster 4 : college",
`pre_knot_time:cluster5:college` = "pre-knot-time : cluster 5 : college",
`pre_knot_time:cluster6:college` = "pre-knot-time : cluster 6 : college",

# post-knot
`post_knot_time` = "post-knot-time",  
`post_knot_time:log_emp_size`  = "post-knot-time : log(emp size)",
`post_knot_time:log_resid_size`  = "post-knot-time : log(res size)",
`post_knot_time:college` = "post-knot-time : college",
`post_knot_time:cluster2` = "post-knot-time : cluster 2",
`post_knot_time:cluster3` = "post-knot-time : cluster 3",  
`post_knot_time:cluster4` = "post-knot-time : cluster 4",
`post_knot_time:cluster5` = "post-knot-time : cluster 5",
`post_knot_time:cluster6` = "post-knot-time : cluster 6",
`post_knot_time:cluster2:college` = "post-knot-time : cluster 2 : college",
`post_knot_time:cluster3:college` = "post-knot-time : cluster 3 : college",  
`post_knot_time:cluster4:college` = "post-knot-time : cluster 4 : college",
`post_knot_time:cluster5:college` = "post-knot-time : cluster 5 : college",
`post_knot_time:cluster6:college` = "post-knot-time : cluster 6 : college"
)
```

```{r}
tab_model(
     sp_2_RCC_knot,
     sp_2_RCC_knot_grav,
     sp_2_RCC_knot_grav_EduIndustry,
     sp_2_RCC_knot_grav_EduIndustry_interact,
     auto.label = TRUE, show.reflvl = TRUE, show.dev = TRUE, show.aic = TRUE, p.style = "stars",
          pred.labels = pl,
     order.terms = c(1, 11, 4, 12, 13, 10, 
                     5, 6, 7, 8, 9,
                     28:32,
                     2, 14, 26, 16:20, 33:37,
                     3, 15, 27, 21:25, 38:42
                     ),
     col.order = c("est", "p"))
```


# -----------
## plot model
### gravitational model(spatial predictors)
```{r fig.align="center", echo = FALSE, fig.width = 20, fig.height = 7}
p1 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "eff",
           terms = c("log_emp_size"))

p2 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "eff",
           terms = c("log_resid_size"))

p3 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "eff",
           terms = c("average_traveltime"))
ggpubr::ggarrange(p1, p2, p3, ncol = 3)
```

### differences in flow volume(at knot, trough) by the education attainment level 
other predictors(both continuous and categorical) controlled in overall mean level
```{r fig.align="center", echo = FALSE, fig.width = 7, fig.height = 7}
plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "eff",
           terms = c("college"))
```

### differences in flow volume(at knot, trough) by the sectoral cluster to which each destination belongs
other predictors(both continuous and categorical) controlled in overall mean level
```{r}
# cluster_5가 낮게 나오는 이유는 이미 이들 고용권역의 고용규모가 emp_size로 통제되었기 때문으로 보임

plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           #type = "pred",
           terms = c("cluster1", "cluster2", "cluster3", "cluster4", "cluster5", "cluster6"),
           show.values = TRUE)
```

### differences in flow volume(at knot, trough) by the edu level(origin) and the sectoral cluster(destination)
other predictors(both continuous and categorical) controlled in overall mean level
```{r}
plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "eff",
           terms = c("cluster", "college [-1, 1]"),
           show.values = TRUE)
```

### temporal change 
other predictors(both continuous and categorical) controlled in overall mean level
```{r fig.align="center", echo = FALSE, fig.width = 14, fig.height = 7}
p1 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "eff",
           terms = c("pre_knot_time"),
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
p2 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "eff",
           terms = c("post_knot_time"),
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
ggpubr::ggarrange(p1, p2, ncol = 2)
```

### differences in temporal change by the employment size of destination
other predictors(both continuous and categorical) controlled in overall mean level
```{r fig.align="center", echo = FALSE, fig.width = 14, fig.height = 7}
p1 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("pre_knot_time", "log_emp_size"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
p2 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("post_knot_time", "log_emp_size"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
ggpubr::ggarrange(p1, p2, ncol = 2)
```

### differences in temporal change by the education attainment level of origin
other predictors(both continuous and categorical) controlled in overall mean level
```{r fig.align="center", echo = FALSE, fig.width = 14, fig.height = 7}
p1 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("pre_knot_time", "college"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
p2 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("post_knot_time", "college"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
ggpubr::ggarrange(p1, p2, ncol = 2)
```

### differences in temporal change by the sectoral cluster to which each destination belongs 
other predictors(both continuous and categorical) controlled in overall mean level
```{r fig.align="center", echo = FALSE, fig.width = 14, fig.height = 7}
p1 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("pre_knot_time", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
p2 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("post_knot_time", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
ggpubr::ggarrange(p1, p2, ncol = 2)
```

### differences in temporal change by the edu level(origin) and the sectoral cluster(destination)
other predictors(both continuous and categorical) controlled in overall mean level
```{r fig.align="center", echo = FALSE, fig.width = 12, fig.height = 7}
p1 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("pre_knot_time", "cluster", "college [-1]"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
p2 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("post_knot_time", "cluster", "college [-1]"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
ggpubr::ggarrange(p1, p2, ncol = 2)
```

```{r fig.align="center", echo = FALSE, fig.width = 12, fig.height = 7}
p1 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("pre_knot_time", "cluster", "college [1]"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
p2 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("post_knot_time", "cluster", "college [1]"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom")
ggpubr::ggarrange(p1, p2, ncol = 2)
```

```{r fig.align="center", echo = FALSE, fig.width = 7, fig.height = 21}
p1 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("pre_knot_time", "college [-1, 1]", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom", 
                 axis.title.x = element_blank(), axis.title.y = element_blank())
p1$facet$params$nrow=6

p2 <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("post_knot_time", "college [-1, 1]", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom", axis.ticks.y = element_blank(), axis.text.y = element_blank(), 
                 axis.title.x = element_blank(), axis.title.y = element_blank())
p2$facet$params$nrow=6
ggpubr::ggarrange(p1, p2, ncol = 2, widths = c(0.52, 0.48))
```

# ---------------------------
# apply to each spline
# -----------
# sp_1
## proper data structure
### import - window cut - visualization
```{r}
data_filtered_resid_emp_ts_timewindow <- data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2020 Jan", "2020 Feb", "2020 Mar", "2020 Apr", "2020 May", "2020 Jun", "2020 Jul")) 
data_filtered_resid_emp_ts_timewindow 
```

### logged - centered and scaled
```{r}
data_filtered_resid_emp_ts_timewindow_logged_centered <- data_filtered_resid_emp_ts_timewindow %>%
    mutate(log_house_price = log(house_price)) %>%
    mutate(log_resid_size = log(resid_size)) %>%
    mutate(log_emp_size = log(emp_size)) %>%    
    mutate(female = scale(female, center = TRUE, scale = TRUE),
           agegroup_2030 = scale(agegroup_2030, center = TRUE, scale = TRUE),
           average_traveltime = scale(average_traveltime, center = TRUE, scale = TRUE),
           one_person_household = scale(one_person_household, center = TRUE, scale = TRUE),
           college = scale(college, center = TRUE, scale = TRUE),
           log_house_price = scale(log_house_price, center = TRUE, scale = TRUE),
           log_emp_size = scale(log_emp_size, center = TRUE, scale = TRUE),
           log_resid_size = scale(log_resid_size, center = TRUE, scale = TRUE))
data_filtered_resid_emp_ts_timewindow_logged_centered
```

### zeroed
```{r}
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed <-
    data_filtered_resid_emp_ts_timewindow_logged_centered %>%
    mutate(Time = Time - 1)
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed 
```

## EDA : spline_1
```{r fig.align="center", echo = FALSE,fig.width = 8, fig.height = 10}
data_filtered_resid_emp_ts %>%
    filter(home != work) %>%
    filter(as.character(Time_ts) %in% c("2020 Jan", "2020 Feb", "2020 Mar", "2020 Apr", "2020 May", "2020 Jun", "2020 Jul")) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(x = Time_ts, y = log(flow))) +
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "point", size = 5) +

    stat_summary(fun.y = mean, color = 'black', size = 1, geom = 'line') +
      scale_y_continuous(name = "mean flow volume") 
```

## analysis 
```{r}
knot = 1

data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled <- 
    data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed %>%
    mutate(pre_knot_time = pmin(0, Time-knot),
           post_knot_time = pmax(0, Time-knot))
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled
```

```{r}
sp_1_RCC_knot_grav_EduIndustry_interact <- lme4::lmer(flow ~ 
                                    
                                    # grav                                                 
                                    (pre_knot_time + post_knot_time) * log_emp_size +
                                    (pre_knot_time + post_knot_time) * log_resid_size +
                                    average_traveltime + internal +
                                        
                                    # education and industry        
                                    (pre_knot_time + post_knot_time) * cluster*college +
                                    
                                    # random effect
                                    (1|hw_link) + (-1 + pre_knot_time|hw_link) + (-1 + post_knot_time|hw_link), 
                       data = data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled)
summary(sp_1_RCC_knot_grav_EduIndustry_interact)
```

# -----------
# sp_2
## proper data structure
### import - window cut - visualization
```{r}
data_filtered_resid_emp_ts_timewindow <- data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2020 Jul", "2020 Aug", "2020 Sep", "2020 Oct", "2020 Nov")) 
data_filtered_resid_emp_ts_timewindow 
```

### logged - centered and scaled
```{r}
data_filtered_resid_emp_ts_timewindow_logged_centered <- data_filtered_resid_emp_ts_timewindow %>%
    mutate(log_house_price = log(house_price)) %>%
    mutate(log_resid_size = log(resid_size)) %>%
    mutate(log_emp_size = log(emp_size)) %>%    
    mutate(female = scale(female, center = TRUE, scale = TRUE),
           agegroup_2030 = scale(agegroup_2030, center = TRUE, scale = TRUE),
           average_traveltime = scale(average_traveltime, center = TRUE, scale = TRUE),
           one_person_household = scale(one_person_household, center = TRUE, scale = TRUE),
           college = scale(college, center = TRUE, scale = TRUE),
           log_house_price = scale(log_house_price, center = TRUE, scale = TRUE),
           log_emp_size = scale(log_emp_size, center = TRUE, scale = TRUE),
           log_resid_size = scale(log_resid_size, center = TRUE, scale = TRUE))
data_filtered_resid_emp_ts_timewindow_logged_centered
```

### zeroed
```{r}
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed <-
    data_filtered_resid_emp_ts_timewindow_logged_centered %>%
    mutate(Time = Time - 7)
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed 
```

## EDA : sp_2
```{r fig.align="center", echo = FALSE,fig.width = 8, fig.height = 10}
data_filtered_resid_emp_ts %>%
    filter(home != work) %>%
    filter(as.character(Time_ts) %in% c("2020 Jul", "2020 Aug", "2020 Sep", "2020 Oct", "2020 Nov")) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(x = Time_ts, y = log(flow))) +
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "point", size = 5) +

    stat_summary(fun.y = mean, color = 'black', size = 1, geom = 'line') +
      scale_y_continuous(name = "mean flow volume") 
```

## analysis 
```{r}
knot = 1

data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled <- 
    data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed %>%
    mutate(pre_knot_time = pmin(0, Time-knot),
           post_knot_time = pmax(0, Time-knot))
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled
```

```{r}
sp_2_RCC_knot_grav_EduIndustry_interact <- lme4::lmer(flow ~ 
                                    
                                    # grav                                                 
                                    (pre_knot_time + post_knot_time) * log_emp_size +
                                    (pre_knot_time + post_knot_time) * log_resid_size +
                                    average_traveltime + internal +
                                        
                                    # education and industry        
                                    (pre_knot_time + post_knot_time) * cluster*college +
                                    
                                    # random effect
                                    (1|hw_link) + (-1 + pre_knot_time|hw_link) + (-1 + post_knot_time|hw_link), 
                       data = data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled)
summary(sp_2_RCC_knot_grav_EduIndustry_interact)
```

# -----------
# sp_3
## proper data structure
### import - window cut - visualization
```{r}
data_filtered_resid_emp_ts_timewindow <- data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2021 Jun","2021 Jul", "2021 Aug", "2021 Sep", "2021 Oct", "2021 Nov", "2021 Dec")) 
data_filtered_resid_emp_ts_timewindow 
```

### logged - centered and scaled
```{r}
data_filtered_resid_emp_ts_timewindow_logged_centered <- data_filtered_resid_emp_ts_timewindow %>%
    mutate(log_house_price = log(house_price)) %>%
    mutate(log_resid_size = log(resid_size)) %>%
    mutate(log_emp_size = log(emp_size)) %>%    
    mutate(female = scale(female, center = TRUE, scale = TRUE),
           agegroup_2030 = scale(agegroup_2030, center = TRUE, scale = TRUE),
           average_traveltime = scale(average_traveltime, center = TRUE, scale = TRUE),
           one_person_household = scale(one_person_household, center = TRUE, scale = TRUE),
           college = scale(college, center = TRUE, scale = TRUE),
           log_house_price = scale(log_house_price, center = TRUE, scale = TRUE),
           log_emp_size = scale(log_emp_size, center = TRUE, scale = TRUE),
           log_resid_size = scale(log_resid_size, center = TRUE, scale = TRUE))
data_filtered_resid_emp_ts_timewindow_logged_centered
```

### zeroed
```{r}
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed <-
    data_filtered_resid_emp_ts_timewindow_logged_centered %>%
    mutate(Time = Time - 18)
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed 
```

## EDA : sp_3
```{r fig.align="center", echo = FALSE,fig.width = 8, fig.height = 10}
data_filtered_resid_emp_ts %>%
    filter(home != work) %>%
    filter(as.character(Time_ts) %in% c("2021 Jun","2021 Jul", "2021 Aug", "2021 Sep", "2021 Oct", "2021 Nov", "2021 Dec")) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(x = Time_ts, y = log(flow))) +
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "point", size = 5) +

    stat_summary(fun.y = mean, color = 'black', size = 1, geom = 'line') +
      scale_y_continuous(name = "mean flow volume") 
```

## analysis 
```{r}
knot = 3

data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled <- 
    data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed %>%
    mutate(pre_knot_time = pmin(0, Time-knot),
           post_knot_time = pmax(0, Time-knot))
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled
```

```{r}
sp_3_RCC_knot_grav_EduIndustry_interact <- lme4::lmer(flow ~ 
                                    
                                    # grav                                                 
                                    (pre_knot_time + post_knot_time) * log_emp_size +
                                    (pre_knot_time + post_knot_time) * log_resid_size +
                                    average_traveltime + internal +
                                        
                                    # education and industry        
                                    (pre_knot_time + post_knot_time) * cluster*college +
                                    
                                    # random effect
                                    (1|hw_link) + (-1 + pre_knot_time|hw_link) + (-1 + post_knot_time|hw_link), 
                       data = data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled)
summary(sp_3_RCC_knot_grav_EduIndustry_interact)
```

# -----------
# sp_4
## proper data structure
### import - window cut - visualization
```{r}
data_filtered_resid_emp_ts_timewindow <- data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2021 Dec", "2022 Jan", "2022 Feb", "2022 Mar", "2022 Apr")) 
data_filtered_resid_emp_ts_timewindow 
```

### logged - centered and scaled
```{r}
data_filtered_resid_emp_ts_timewindow_logged_centered <- data_filtered_resid_emp_ts_timewindow %>%
    mutate(log_house_price = log(house_price)) %>%
    mutate(log_resid_size = log(resid_size)) %>%
    mutate(log_emp_size = log(emp_size)) %>%    
    mutate(female = scale(female, center = TRUE, scale = TRUE),
           agegroup_2030 = scale(agegroup_2030, center = TRUE, scale = TRUE),
           average_traveltime = scale(average_traveltime, center = TRUE, scale = TRUE),
           one_person_household = scale(one_person_household, center = TRUE, scale = TRUE),
           college = scale(college, center = TRUE, scale = TRUE),
           log_house_price = scale(log_house_price, center = TRUE, scale = TRUE),
           log_emp_size = scale(log_emp_size, center = TRUE, scale = TRUE),
           log_resid_size = scale(log_resid_size, center = TRUE, scale = TRUE))
data_filtered_resid_emp_ts_timewindow_logged_centered
```

### zeroed
```{r}
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed <-
    data_filtered_resid_emp_ts_timewindow_logged_centered %>%
    mutate(Time = Time - 24)
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed 
```

## EDA : sp_4
```{r fig.align="center", echo = FALSE,fig.width = 8, fig.height = 10}
data_filtered_resid_emp_ts %>%
    filter(home != work) %>%
    filter(as.character(Time_ts) %in% c("2021 Dec", "2022 Jan", "2022 Feb", "2022 Mar", "2022 Apr")) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(x = Time_ts, y = log(flow))) +
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(aes(shape = cluster, col = college_quartile),
                    fun.data = mean_se, geom = "point", size = 5) +

    stat_summary(fun.y = mean, color = 'black', size = 1, geom = 'line') +
      scale_y_continuous(name = "mean flow volume") 
```

## analysis 
```{r}
knot = 2

data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled <- 
    data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed %>%
    mutate(pre_knot_time = pmin(0, Time-knot),
           post_knot_time = pmax(0, Time-knot))
data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled
```

```{r}
sp_4_RCC_knot_grav_EduIndustry_interact <- lme4::lmer(flow ~ 
                                    
                                    # grav                                                 
                                    (pre_knot_time + post_knot_time) * log_emp_size +
                                    (pre_knot_time + post_knot_time) * log_resid_size +
                                    average_traveltime + internal +
                                        
                                    # education and industry        
                                    (pre_knot_time + post_knot_time) * cluster*college +
                                    
                                    # random effect
                                    (1|hw_link) + (-1 + pre_knot_time|hw_link) + (-1 + post_knot_time|hw_link), 
                       data = data_filtered_resid_emp_ts_timewindow_logged_centered_zeroed_simpled)
summary(sp_4_RCC_knot_grav_EduIndustry_interact)
```

# ---------------------------
# tab model  
```{r}
pl <- c(
# at the baseline : knot    
`(Intercept)` = "Intercept",
internal1 = "internal commute",
log_emp_size = "log(emp size)",
log_resid_size = "log(res size)",
average_traveltime = "travel time distance",
college = "college",
`cluster2` = "cluster 2",
`cluster3` = "cluster 3",  
`cluster4` = "cluster 4",
`cluster5` = "cluster 5",
`cluster6` = "cluster 6",
`cluster2:college` = "cluster 2 : college",
`cluster3:college` = "cluster 3 : college",  
`cluster4:college` = "cluster 4 : college",
`cluster5:college` = "cluster 5 : college",
`cluster6:college` = "cluster 6 : college",

# pre-knot
`pre_knot_time` = "pre-knot-time",
`pre_knot_time:log_emp_size`  = "pre-knot-time : log(emp size)",
`pre_knot_time:log_res_size`  = "pre-knot-time : log(res size)",
`pre_knot_time:college` = "pre-knot-time : college",
`pre_knot_time:cluster2` = "pre-knot-time : cluster 2",
`pre_knot_time:cluster3` = "pre-knot-time : cluster 3",  
`pre_knot_time:cluster4` = "pre-knot-time : cluster 4",
`pre_knot_time:cluster5` = "pre-knot-time : cluster 5",
`pre_knot_time:cluster6` = "pre-knot-time : cluster 6",
`pre_knot_time:cluster2:college` = "pre-knot-time : cluster 2 : college",
`pre_knot_time:cluster3:college` = "pre-knot-time : cluster 3 : college",  
`pre_knot_time:cluster4:college` = "pre-knot-time : cluster 4 : college",
`pre_knot_time:cluster5:college` = "pre-knot-time : cluster 5 : college",
`pre_knot_time:cluster6:college` = "pre-knot-time : cluster 6 : college",

# post-knot
`post_knot_time` = "post-knot-time",  
`post_knot_time:log_emp_size`  = "post-knot-time : log(emp size)",
`post_knot_time:log_res_size`  = "post-knot-time : log(res size)",
`post_knot_time:college` = "post-knot-time : college",
`post_knot_time:cluster2` = "post-knot-time : cluster 2",
`post_knot_time:cluster3` = "post-knot-time : cluster 3",  
`post_knot_time:cluster4` = "post-knot-time : cluster 4",
`post_knot_time:cluster5` = "post-knot-time : cluster 5",
`post_knot_time:cluster6` = "post-knot-time : cluster 6",
`post_knot_time:cluster2:college` = "post-knot-time : cluster 2 : college",
`post_knot_time:cluster3:college` = "post-knot-time : cluster 3 : college",  
`post_knot_time:cluster4:college` = "post-knot-time : cluster 4 : college",
`post_knot_time:cluster5:college` = "post-knot-time : cluster 5 : college",
`post_knot_time:cluster6:college` = "post-knot-time : cluster 6 : college"
)
```

```{r}
tab_model(
     sp_1_RCC_knot_grav_EduIndustry_interact,
     sp_2_RCC_knot_grav_EduIndustry_interact,
     sp_3_RCC_knot_grav_EduIndustry_interact,
     sp_4_RCC_knot_grav_EduIndustry_interact,
     auto.label = TRUE, show.reflvl = TRUE, show.dev = TRUE, show.aic = TRUE, p.style = "stars",
          pred.labels = pl,
     order.terms = c(1, 11, 4, 12, 13, 10, 
                     5, 6, 7, 8, 9,
                     28:32,
                     2, 14, 26, 16:20, 33:37,
                     3, 15, 27, 21:25, 38:42
                     ),
     col.order = c("est", "p"))
```


```{r}
tab_model(
     sp_1_RCC_knot_grav_EduIndustry_interact,
     sp_2_RCC_knot_grav_EduIndustry_interact,
     sp_3_RCC_knot_grav_EduIndustry_interact,
     sp_4_RCC_knot_grav_EduIndustry_interact,
     auto.label = TRUE, show.reflvl = TRUE, show.dev = TRUE, show.aic = TRUE, p.style = "stars",
          pred.labels = pl,
    # order.terms = c(1, 11, 4, 12, 13, 10, 
    #                 5, 6, 7, 8, 9,
    #                 28:32,
    #                 2, 14, 26, 16:20, 33:37,
    #                 3, 15, 27, 21:25, 38:42
    #                      ),
     col.order = c("est", "p"))
```


# ---------------------------
# plot model
```{r fig.align="center", echo = FALSE, fig.width = 7, fig.height = 21}
###### sp_1
sp_1_decline <- plot_model(sp_1_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("pre_knot_time", "college [-1, 1]", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom", 
                 axis.title.x = element_blank(), axis.title.y = element_blank()) + 
    ggtitle("")
sp_1_decline$facet$params$nrow=6

sp_1_recover <- plot_model(sp_1_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("post_knot_time", "college [-1, 1]", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom", axis.ticks.y = element_blank(), axis.text.y = element_blank(), 
                 axis.title.x = element_blank(), axis.title.y = element_blank()) + 
    ggtitle("")
sp_1_recover$facet$params$nrow=6

###### sp_2
sp_2_decline <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("pre_knot_time", "college [-1, 1]", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom", 
                 axis.title.x = element_blank(), axis.title.y = element_blank()) + 
    ggtitle("")
sp_2_decline$facet$params$nrow=6

sp_2_recover <- plot_model(sp_2_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("post_knot_time", "college [-1, 1]", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom", axis.ticks.y = element_blank(), axis.text.y = element_blank(), 
                 axis.title.x = element_blank(), axis.title.y = element_blank()) + 
    ggtitle("")
sp_2_recover$facet$params$nrow=6

###### sp_3
sp_3_decline <- plot_model(sp_3_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("pre_knot_time", "college [-1, 1]", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom", 
                 axis.title.x = element_blank(), axis.title.y = element_blank()) + 
    ggtitle("")
sp_3_decline$facet$params$nrow=6

sp_3_recover <- plot_model(sp_3_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("post_knot_time", "college [-1, 1]", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom", axis.ticks.y = element_blank(), axis.text.y = element_blank(), 
                 axis.title.x = element_blank(), axis.title.y = element_blank()) + 
    ggtitle("")

sp_3_recover$facet$params$nrow=6

###### sp_4
sp_4_decline <- plot_model(sp_4_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("pre_knot_time", "college [-1, 1]", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom", axis.title.x = element_blank(), axis.title.y = element_blank(),
                 title = element_blank()) + 
    ggtitle("")
sp_4_decline$facet$params$nrow=6

sp_4_recover <- plot_model(sp_4_RCC_knot_grav_EduIndustry_interact,
           type = "pred",
           terms = c("post_knot_time", "college [-1, 1]", "cluster"),
           ndrt.values = "meansd",
           show.values = TRUE,
           line.size = 1.5) +
           theme(legend.position = "bottom", axis.ticks.y = element_blank(), axis.text.y = element_blank(), 
                 axis.title.x = element_blank(), axis.title.y = element_blank()) + 
    ggtitle("")
sp_4_recover$facet$params$nrow=6
```


```{r}
library(ggpubr)
```

```{r}
sp_1 <- ggpubr::ggarrange(sp_1_decline, sp_1_recover, ncol = 2, widths = c(1/6, 5/6))
sp_1 <- ggpubr::annotate_figure(sp_1, top = text_grob("Spline_1"))

sp_2 <- ggpubr::ggarrange(sp_2_decline, sp_2_recover, ncol = 2, widths = c(1/4, 3/4))
sp_2 <- ggpubr::annotate_figure(sp_2, top = text_grob("Spline_2"))

sp_3 <- ggpubr::ggarrange(sp_3_decline, sp_3_recover, ncol = 2, widths = c(3/5, 2/5))
sp_3 <- ggpubr::annotate_figure(sp_3, top = text_grob("Spline_3"))

sp_4 <- ggpubr::ggarrange(sp_4_decline, sp_4_recover, ncol = 2, widths = c(2/4, 2/4))
sp_4 <- ggpubr::annotate_figure(sp_4, top = text_grob("Spline_4"))
```

```{r fig.align="center", echo = FALSE, fig.width = 7, fig.height = 21}
ggpubr::ggarrange(sp_4)
```


```{r fig.align="center", echo = FALSE, fig.width = 28, fig.height = 21}
ggpubr::ggarrange(sp_1, sp_2, sp_3, sp_4,
                  ncol = 4)
```

\
\

# -------------------------------------------------------
# -------------------------------------------------------
# -------------------------------------------------------
# In-depth analysis for the source of interaction effect
## ex) spline_2 
## scatterplot
```{r}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(flow_202007, cluster, college, share_of_KIBS, diminish_rate_07_08, recovery_rate_08_11)
```

```{r}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11_highedu <- data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(home, work, flow_202007, cluster, college, share_of_KIBS, diminish_rate_07_08, recovery_rate_08_11) %>%
    filter(college > quantile(college, 0.75))
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11_highedu
```

```{r}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11_highedu %>%
    group_by(cluster) %>%
    summarise(diminish_rate_07_08 = mean(diminish_rate_07_08))
```

```{r fig.align="center", echo = FALSE,fig.width = 7, fig.height = 10}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11_highedu %>%
    ggplot(aes(x = cluster, y = diminish_rate_07_08)) +
    geom_jitter(width = 0.3) +
    ylim(0.4, 1.15)
```

```{r}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11_lowedu <-
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11 %>%
    distinct(home, work, .keep_all = TRUE) %>%
    select(home, work, flow_202007, cluster, college, share_of_KIBS, diminish_rate_07_08, recovery_rate_08_11) %>%
    filter(college < quantile(college, 0.25))
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11_lowedu
```

```{r}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11_lowedu %>%
    group_by(cluster) %>%
    summarise(diminish_rate_07_08 = mean(diminish_rate_07_08))
```

```{r fig.align="center", echo = FALSE,fig.width = 7, fig.height = 10}
data_filtered_resid_emp_ts_timewindow_wave2_202007_08_11_lowedu %>%
    ggplot(aes(x = cluster, y = diminish_rate_07_08)) +
    geom_jitter(width = 0.3) +
    ylim(0.4, 1.15)
```

## facet-ed lines
```{r}
data_filtered_resid_emp_ts_timewindow <-data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2020 Jul", "2020 Aug", "2020 Sep", "2020 Oct", "2020 Nov")) %>%
    mutate(college_quartile = case_when(
        quantile(college, 0.75) < college ~ "high",
        quantile(college, 0.50) < college & college <= quantile(college, 0.75) ~ "medium_high",
        quantile(college, 0.25) < college & college <= quantile(college, 0.50) ~ "medium_low",
        college <= quantile(college, 0.25) ~ "low"
    ))
data_filtered_resid_emp_ts_timewindow
```

```{r fig.align="center", echo = FALSE,fig.width = 10, fig.height = 10}
data_filtered_resid_emp_ts_timewindow %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(Time_ts, flow, shape = cluster, col = college_quartile)) +
    stat_summary(fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(fun.data = mean_se, geom = "point", size = 5)
```

\
\

# -------------------------------------------------------
# -------------------------------------------------------
# -------------------------------------------------------
# longitudinal extension
## sp_1
```{r}
data_filtered_resid_emp_ts_timewindow <-data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2020 Jan", "2020 Feb", "2020 Mar", "2020 Apr", "2020 May", "2020 Jun", "2020 Jul")) %>%
    mutate(college_quartile = case_when(
        quantile(college, 0.75) < college ~ "high",
        quantile(college, 0.50) < college & college <= quantile(college, 0.75) ~ "medium_high",
        quantile(college, 0.25) < college & college <= quantile(college, 0.50) ~ "medium_low",
        college <= quantile(college, 0.25) ~ "low"
    ))
data_filtered_resid_emp_ts_timewindow
```

```{r fig.align="center", echo = FALSE,fig.width = 10, fig.height = 10}
data_filtered_resid_emp_ts_timewindow %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(Time_ts, flow, shape = cluster, col = college_quartile)) +
    stat_summary(fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(fun.data = mean_se, geom = "point", size = 5)
```

```{r fig.align="center", echo = FALSE,fig.width = 10, fig.height = 10}
data_filtered_resid_emp_ts_timewindow %>%
    filter(home != work) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(Time_ts, flow, shape = cluster, col = college_quartile)) +
    stat_summary(fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(fun.data = mean_se, geom = "point", size = 5)
```

## sp_2
```{r}
data_filtered_resid_emp_ts_timewindow <-data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2020 Jul", "2020 Aug", "2020 Sep", "2020 Oct", "2020 Nov")) %>%
    mutate(college_quartile = case_when(
        quantile(college, 0.75) < college ~ "high",
        quantile(college, 0.50) < college & college <= quantile(college, 0.75) ~ "medium_high",
        quantile(college, 0.25) < college & college <= quantile(college, 0.50) ~ "medium_low",
        college <= quantile(college, 0.25) ~ "low"
    ))
data_filtered_resid_emp_ts_timewindow
```

```{r fig.align="center", echo = FALSE,fig.width = 10, fig.height = 10}
data_filtered_resid_emp_ts_timewindow %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(Time_ts, flow, shape = cluster, col = college_quartile)) +
    stat_summary(fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(fun.data = mean_se, geom = "point", size = 5)
```

```{r fig.align="center", echo = FALSE,fig.width = 10, fig.height = 10}
data_filtered_resid_emp_ts_timewindow %>%
    filter(home != work) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(Time_ts, flow, shape = cluster, col = college_quartile)) +
    stat_summary(fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(fun.data = mean_se, geom = "point", size = 5)
```

## sp_3
```{r}
data_filtered_resid_emp_ts_timewindow <-data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2021 Jun","2021 Jul", "2021 Aug", "2021 Sep", "2021 Oct", "2021 Nov", "2021 Dec")) %>%
    mutate(college_quartile = case_when(
        quantile(college, 0.75) < college ~ "high",
        quantile(college, 0.50) < college & college <= quantile(college, 0.75) ~ "medium_high",
        quantile(college, 0.25) < college & college <= quantile(college, 0.50) ~ "medium_low",
        college <= quantile(college, 0.25) ~ "low"
    ))
data_filtered_resid_emp_ts_timewindow
```

```{r fig.align="center", echo = FALSE,fig.width = 10, fig.height = 10}
data_filtered_resid_emp_ts_timewindow %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(Time_ts, flow, shape = cluster, col = college_quartile)) +
    stat_summary(fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(fun.data = mean_se, geom = "point", size = 5)
```

```{r fig.align="center", echo = FALSE,fig.width = 10, fig.height = 10}
data_filtered_resid_emp_ts_timewindow %>%
    filter(home != work) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(Time_ts, flow, shape = cluster, col = college_quartile)) +
    stat_summary(fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(fun.data = mean_se, geom = "point", size = 5)
```

## sp_4
```{r}
data_filtered_resid_emp_ts_timewindow <- data_filtered_resid_emp_ts %>%
    filter(as.character(Time_ts) %in% c("2021 Dec", "2022 Jan", "2022 Feb", "2022 Mar", "2022 Apr")) %>%
    mutate(college_quartile = case_when(
        quantile(college, 0.75) < college ~ "high",
        quantile(college, 0.50) < college & college <= quantile(college, 0.75) ~ "medium_high",
        quantile(college, 0.25) < college & college <= quantile(college, 0.50) ~ "medium_low",
        college <= quantile(college, 0.25) ~ "low"
    ))
data_filtered_resid_emp_ts_timewindow
```

```{r fig.align="center", echo = FALSE,fig.width = 10, fig.height = 10}
data_filtered_resid_emp_ts_timewindow %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(Time_ts, flow, shape = cluster, col = college_quartile)) +
    stat_summary(fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(fun.data = mean_se, geom = "point", size = 5)
```

```{r fig.align="center", echo = FALSE,fig.width = 10, fig.height = 10}
data_filtered_resid_emp_ts_timewindow %>%
    filter(home != work) %>%
    filter(college_quartile %in% c("high", "low")) %>%
    ggplot(aes(Time_ts, flow, shape = cluster, col = college_quartile)) +
    stat_summary(fun.data = mean_se, geom = "line", size = 1, alpha = 0.3) + 
    stat_summary(fun.data = mean_se, geom = "point", size = 5)
```





















